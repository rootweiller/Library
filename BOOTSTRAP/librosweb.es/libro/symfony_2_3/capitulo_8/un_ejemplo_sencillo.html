<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml" xml:lang="es" lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <title>8.1. Un ejemplo sencillo (Symfony 2.3, el libro oficial)</title>
                                    <link rel="stylesheet" href="/css/app.css" />
                        <script type="text/javascript">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-82842-2', 'librosweb.es');
            ga('require', 'displayfeatures');
            ga('send', 'pageview');
        </script>
                        <link rel="apple-touch-icon" type="image/png" href="/apple-touch-icon.png">
        <link rel="apple-touch-icon-precomposed" type="image/png" href="/apple-touch-icon.png">
        <meta name="apple-mobile-web-app-title" content="LibrosWeb">
        <link rel="shortcut icon" type="image/png" href="/favicon.png">
        <meta name="site-version" content="a7f65a4">
                <link rel="publisher" href="http://plus.google.com/112008023125011571577">
                            
        <link rel="canonical" href="/libro/symfony_2_x/capitulo_8/un_ejemplo_sencillo.html"/>
                                    <link rel="prev" href="../capitulo_8.html" />
                    <link rel="next" href="../capitulo_8/buscando_objetos.html" />
                <link rel="start" href="/libro/symfony_2_3/" />
                <meta name="twitter:site" content="@librosweb">
                <link rel="search" type="application/opensearchdescription+xml" href="http://librosweb.es/opensearch/documentation.xml" title="LibrosWeb">
                <meta property="fb:page_id" content="437758756273955">
                <meta property="fb:app_id" content="437758756273955">
        <meta property="og:type" content="website">
        <meta property="og:title" content="8.1. Un ejemplo sencillo (Symfony 2.3, el libro oficial)">
        <meta property="og:image" content="http://www.gravatar.com/avatar/9f219b4dfaa677bfd0f47753c02d5126.png?s=200">
                <meta name="msapplication-TileColor" content="#CC1414">
        <meta name="application-name" content="LibrosWeb">
        <meta name="msapplication-tooltip" content="Libros y tutoriales sobre HTML, CSS, JavaScript, PHP y otras tecnologías web.">
    </head>

    <body id="p-1-2" class="books book_page symfony_2_3"><script type="text/javascript">
//<![CDATA[
try{(function(a){var b="http://",c="librosweb.es",d="/cdn-cgi/cl/",e="img.gif",f=new a;f.src=[b,c,d,e].join("")})(Image)}catch(e){}
//]]>
</script>
        <div class="content-background"></div>

        <div id="header">
            <div class="navbar navbar-default navbar-static-top">
              <div class="container">
                <div class="navbar-header">
                  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#header-menu">
                    <span class="sr-only">Desplegar menú</span>
                    <i class="fa fa-menu"></i>
                  </button>
                  <a class="navbar-brand" href="/" title="LibrosWeb.es">
                      <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 132 32" preserveAspectRatio="xMinYMin meet">
<g fill="#CC1414" transform="translate(-21.738 -21.148)">
<path d="m24.062 23.486v28h9.64v-5h-4.04v-23h-5.6"/>
<path d="m40.796 23.486h-5.6v28h5.6v-28"/>
<path d="m53.932 37.006c1.48-0.56 2.32-1.76 2.32-4.16v-4.16c0-3.48-1.72-5.2-5.2-5.2h-8.24v28h8.32c3.48 0 5.2-1.72 5.2-5.2v-5.68c0-2.04-0.72-3.12-2.4-3.6m-3.24-7.72v4.64c0 0.68-0.32 1-1 1h-1.32v-6.64h1.32c0.68 0 1 0.32 1 1m-2.32 10.32h1.4c0.68 0 1 0.32 1 1v5.08c0 0.68-0.32 1-1 1h-1.4v-7.08"/>
<path d="m69.284 38.246c1.52-0.56 2.4-1.76 2.4-4.16v-5.4c0-3.48-1.72-5.2-5.2-5.2h-8.36v28h5.6v-10.6h1.4c0.68 0 1 0.32 1 1v9.6h5.6v-9.64c0-2.04-0.72-3.12-2.44-3.6m-3.2-8.88v5.76c0 0.68-0.32 1-1 1h-1.36v-7.76h1.36c0.68 0 1 0.32 1 1"/>
<path d="m87.513 46.526v-18.08c0-3.48-1.72-5.2-5.2-5.2h-3.6c-3.48 0-5.2 1.72-5.2 5.2v18.08c0 3.48 1.72 5.2 5.2 5.2h3.6c3.48 0 5.2-1.72 5.2-5.2m-5.6-17.48v16.88c0 0.68-0.32 1-1 1h-0.8c-0.68 0-1-0.32-1-1v-16.88c0-0.68 0.32-1 1-1h0.8c0.68 0 1 0.32 1 1"/>
<path d="m100.57 36.966-4.8-3.56c-0.68-0.48-0.96-0.92-0.96-1.8v-2.64c0-0.68 0.32-1 1-1h0.44c0.68 0 1 0.32 1 1v4.6h5.48v-5.12c0-3.48-1.72-5.2-5.2-5.2h-3.04c-3.48 0-5.2 1.72-5.2 5.2v4.44c0 2 0.52 3.16 2.24 4.4l4.8 3.56c0.68 0.48 0.96 0.92 0.96 1.8v3.36c0 0.68-0.32 1-1 1h-0.52c-0.68 0-1-0.32-1-1v-5.44h-5.48v5.96c0 3.48 1.72 5.2 5.2 5.2h3.12c3.48 0 5.2-1.72 5.2-5.2v-5.16c0-2.08-0.52001-3.16-2.24-4.4"/>
<path d="m106.98 51.486h6.16l1.44-12.72 1.44 12.72h6.16l3.4-28h-4.96l-1.44 14.88-1.6-14.88h-5.28l-1.6 14.92-1.44-14.92h-5.68l3.4 28"/>
<path d="m126.87 23.486v28h10.48v-5h-4.88v-6.72h4.6v-5h-4.6v-6.28h4.8v-5h-10.4"/>
<path d="m150.26 37.006c1.48-0.56 2.32-1.76 2.32-4.16v-4.16c0-3.48-1.72-5.2-5.2-5.2h-8.24v28h8.32c3.48 0 5.2-1.72 5.2-5.2v-5.68c0-2.04-0.72001-3.12-2.4-3.6m-3.24-7.72v4.64c0 0.68-0.32001 1-1 1h-1.32v-6.64h1.32c0.67999 0 1 0.32 1 1m-2.32 10.32h1.4c0.67999 0 1 0.32 1 1v5.08c0 0.68-0.32001 1-1 1h-1.4v-7.08"/>
</g>
</svg>
                      <span>LibrosWeb</span>
                  </a>
                </div>

                <div class="collapse navbar-collapse navbar-right" id="header-menu">
                  <ul class="nav navbar-nav pull-right">
                    
                                                <li class="">
                            <a href="/">
                                Inicio
                            </a>
                        </li>
                                                <li class="active">
                            <a href="/libros/">
                                Libros
                            </a>
                        </li>
                                                <li class="">
                            <a href="/tutoriales/">
                                Tutoriales
                            </a>
                        </li>
                                                <li class="">
                            <a href="/eventos/">
                                Eventos
                            </a>
                        </li>
                                                <li class="">
                            <a href="/foro/">
                                Foro
                            </a>
                        </li>
                                                <li class="">
                            <a href="/buscar">
                                Buscar
                            </a>
                        </li>
                                          </ul>
                </div>
              </div>
            </div>
        </div>

        <div id="wrapper" class="container">

            <div id="content" class="row">
                                    <div id="main" class="col-sm-9">
                        
    
    <div id="book-toc-anchor" class="well visible-xs">
        <a href="#indice">
            <i class="fa fa-book"></i> Ver índice de contenidos del libro
        </a>
    </div>

    <div id="breadcrumb" class="hidden-xs">
        <ol>
            <li itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
                <a href="/libros/" itemprop="url">
                    <span itemprop="title">Libros</span>
                </a>
            </li>

            <li itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
                <a href="/libro/symfony_2_3/" itemprop="url">
                    <span itemprop="title">Symfony 2.3, el libro oficial</span>
                </a>
            </li>

                    <li itemscope itemtype="http://data-vocabulary.org/Breadcrumb">
                <a href="/libro/symfony_2_3/capitulo_8.html" itemprop="url">
                    <span itemprop="title">Capítulo 8. La base de datos y Doctrine</span>
                </a>
            </li>
        
            <li class="active">
                <span>8.1. Un ejemplo sencillo</span>
            </li>
        </ol>
    </div>

    <h1 id="un_ejemplo_sencillo" class="title">
        <span>8.1.</span> Un ejemplo sencillo
    </h1>

    

<p>La forma más fácil de entender cómo funciona Doctrine consiste en verlo en acción. En esta sección se configura el acceso a la base de datos, se crea un objeto llamado <code>Product</code>, se persiste su información en la base de datos y se obtiene de nuevo mediante una consulta.</p>

<p>Si quieres seguir este capítulo mientras programas los ejemplos, tienes que crear primero un <em>bundle</em> de prueba con el siguiente comando de Symfony:</p>

<div class="code cli">
<pre class="cli">$ php app/console generate:bundle --namespace=Acme/StoreBundle</pre>
</div>

<h3 id="configurando_la_base_de_datos">8.1.1. Configurando la base de datos</h3>

<p>Antes de comenzar, es necesario configurar la información para acceder a la base de datos. Por convención, esta información se configura en el archivo <code>app/config/parameters.yml</code>:</p>

<div class="code yaml">
<pre class="yaml"><span class="co1"># app/config/parameters.yml</span><span class="co4">
parameters</span>:<span class="co3">
    database_driver</span><span class="sy2">: </span>  pdo_mysql<span class="co3">
    database_host</span><span class="sy2">: </span>    localhost<span class="co3">
    database_name</span><span class="sy2">: </span>    test_project<span class="co3">
    database_user</span><span class="sy2">: </span>    root<span class="co3">
    database_password</span><span class="sy2">: </span>password
&nbsp;
<span class="co1"># ...</span></pre>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> Definir la configuración en el archivo <code>parameters.yml</code> sólo es una convención. De hecho, estos parámetros realmente se utilizan en el archivo de configuración principal de la aplicación:</p>

<div class="tabbable">
  <ul class="nav nav-tabs"><li id="select_tab_1_5f21a" class="active"><a data-toggle="tab active" href="#select_tab_1_5f21a" onclick="document.getElementById('select_tab_1_5f21a').className='active'; document.getElementById('tab_1_5f21a').className='tab-pane active';document.getElementById('select_tab_2_5f21a').className='';  document.getElementById('tab_2_5f21a').className='tab-pane';document.getElementById('select_tab_3_5f21a').className='';  document.getElementById('tab_3_5f21a').className='tab-pane';return false;">YAML</a></li><li id="select_tab_2_5f21a"><a data-toggle="tab" href="#select_tab_2_5f21a" onclick="document.getElementById('select_tab_1_5f21a').className='';  document.getElementById('tab_1_5f21a').className='tab-pane';document.getElementById('select_tab_2_5f21a').className='active'; document.getElementById('tab_2_5f21a').className='tab-pane active';document.getElementById('select_tab_3_5f21a').className='';  document.getElementById('tab_3_5f21a').className='tab-pane';return false;">XML</a></li><li id="select_tab_3_5f21a"><a data-toggle="tab" href="#select_tab_3_5f21a" onclick="document.getElementById('select_tab_1_5f21a').className='';  document.getElementById('tab_1_5f21a').className='tab-pane';document.getElementById('select_tab_2_5f21a').className='';  document.getElementById('tab_2_5f21a').className='tab-pane';document.getElementById('select_tab_3_5f21a').className='active'; document.getElementById('tab_3_5f21a').className='tab-pane active';return false;">PHP</a></li></ul>
  <div class="tab-content">
    <div class="tab-pane active" id="tab_1_5f21a">
<div class="code yaml">
<pre class="yaml"><span class="co1"># app/config/config.yml</span><span class="co4">
doctrine</span>:<span class="co4">
    dbal</span>:<span class="co3">
        driver</span><span class="sy2">: </span>  <span class="st0">&quot;%database_driver%&quot;</span><span class="co3">
        host</span><span class="sy2">: </span>    <span class="st0">&quot;%database_host%&quot;</span><span class="co3">
        dbname</span><span class="sy2">: </span>  <span class="st0">&quot;%database_name%&quot;</span><span class="co3">
        user</span><span class="sy2">: </span>    <span class="st0">&quot;%database_user%&quot;</span><span class="co3">
        password</span><span class="sy2">: </span><span class="st0">&quot;%database_password%&quot;</span></pre>
</div>
</div>


<div class="tab-pane" id="tab_2_5f21a">
<div class="code xml">
<pre class="xml"><span class="sc-1">&lt;!-- app/config/config.xml --&gt;</span>
<span class="sc3"><span class="re1">&lt;doctrine:config<span class="re2">&gt;</span></span></span>
    <span class="sc3"><span class="re1">&lt;doctrine:dbal</span></span>
<span class="sc3">        <span class="re0">driver</span>=<span class="st0">&quot;%database_driver%&quot;</span></span>
<span class="sc3">        <span class="re0">host</span>=<span class="st0">&quot;%database_host%&quot;</span></span>
<span class="sc3">        <span class="re0">dbname</span>=<span class="st0">&quot;%database_name%&quot;</span></span>
<span class="sc3">        <span class="re0">user</span>=<span class="st0">&quot;%database_user%&quot;</span></span>
<span class="sc3">        <span class="re0">password</span>=<span class="st0">&quot;%database_password%&quot;</span></span>
<span class="sc3">    <span class="re2">&gt;</span></span>
<span class="sc3"><span class="re1">&lt;/doctrine:config<span class="re2">&gt;</span></span></span></pre>
</div>
</div>


<div class="tab-pane" id="tab_3_5f21a">
<div class="code php">
<pre class="php"><span class="co1">// app/config/config.php</span>
<span class="re0">$configuration</span><span class="sy0">-&gt;</span><span class="me1">loadFromExtension</span><span class="br0">&#40;</span><span class="st_h">'doctrine'</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span>
    <span class="st_h">'dbal'</span> <span class="sy0">=&gt;</span> <span class="kw3">array</span><span class="br0">&#40;</span>
        <span class="st_h">'driver'</span>   <span class="sy0">=&gt;</span> <span class="st_h">'%database_driver%'</span><span class="sy0">,</span>
        <span class="st_h">'host'</span>     <span class="sy0">=&gt;</span> <span class="st_h">'%database_host%'</span><span class="sy0">,</span>
        <span class="st_h">'dbname'</span>   <span class="sy0">=&gt;</span> <span class="st_h">'%database_name%'</span><span class="sy0">,</span>
        <span class="st_h">'user'</span>     <span class="sy0">=&gt;</span> <span class="st_h">'%database_user%'</span><span class="sy0">,</span>
        <span class="st_h">'password'</span> <span class="sy0">=&gt;</span> <span class="st_h">'%database_password%'</span><span class="sy0">,</span>
    <span class="br0">&#41;</span><span class="sy0">,</span>
<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>
</div>

  </div>
</div>

<p>Al definir la información de la base de datos en un archivo independiente, puedes mantener fácilmente diferentes versiones del archivo en cada servidor. Además, así puedes almacenar fácilmente la configuración de la base de datos (o cualquier otra información sensible) fuera de tu proyecto.</p></div>

<p>Ahora que Doctrine ya conoce tu base de datos, puedes utilizar el siguiente comando para crearla:</p>

<div class="code cli">
<pre class="cli">$ php app/console doctrine:database:create</pre>
</div>

<div class="admonition sidebar"><p><strong class="title"> Configurando la base de datos como UTF8</strong> Uno de los errores más habituales que cometen incluso los programadores más experimentados consiste en no configurar correctamente la codificación de caracteres de la base de datos.</p>

<p>En ocasiones, el problema es que lo configuran bien la primera vez, pero no cada vez que se crea de nuevo la base de datos. Esto sucede mucho cuando se desarrolla la aplicación, ya que es habitual emplear los siguientes comandos para borrar la base de datos y regenerarla con nueva información:</p>

<div class="code cli">
<pre class="cli">$ php app/console doctrine:database:drop --force
$ php app/console doctrine:database:create</pre>
</div>

<p>Doctrine no permite configurar estos valores por defecto en su archivo de configuración, ya que trata de ser lo más <em>agnóstico</em> posible en lo que se refiere a la configuración del entorno de ejecución.</p>

<p>Así que la solución más sencilla consiste en establecer estos valores por defecto en la propia configuración del servidor de base de datos. Si utilizas MySQL, añade las dos siguientes líneas en su archivo de configuración, que normalmente es <code>my.cnf</code>:</p>

<div class="code ini">
<pre class="ini"><span class="re0"><span class="br0">&#91;</span>mysqld<span class="br0">&#93;</span></span>
<span class="re1">collation-server</span> <span class="sy0">=</span><span class="re2"> utf8_general_ci</span>
<span class="re1">character-set-server</span> <span class="sy0">=</span><span class="re2"> utf8</span></pre>
</div>

<p></p></div>

<h3 id="utilizando_sqlite">8.1.2. Utilizando SQLite</h3>

<p>Si utilizas SQLite como base de datos, configura la ruta del archivo donde se guarda la información de la base de datos:</p>

<div class="tabbable">
  <ul class="nav nav-tabs"><li id="select_tab_1_5f30e" class="active"><a data-toggle="tab active" href="#select_tab_1_5f30e" onclick="document.getElementById('select_tab_1_5f30e').className='active'; document.getElementById('tab_1_5f30e').className='tab-pane active';document.getElementById('select_tab_2_5f30e').className='';  document.getElementById('tab_2_5f30e').className='tab-pane';document.getElementById('select_tab_3_5f30e').className='';  document.getElementById('tab_3_5f30e').className='tab-pane';return false;">YAML</a></li><li id="select_tab_2_5f30e"><a data-toggle="tab" href="#select_tab_2_5f30e" onclick="document.getElementById('select_tab_1_5f30e').className='';  document.getElementById('tab_1_5f30e').className='tab-pane';document.getElementById('select_tab_2_5f30e').className='active'; document.getElementById('tab_2_5f30e').className='tab-pane active';document.getElementById('select_tab_3_5f30e').className='';  document.getElementById('tab_3_5f30e').className='tab-pane';return false;">XML</a></li><li id="select_tab_3_5f30e"><a data-toggle="tab" href="#select_tab_3_5f30e" onclick="document.getElementById('select_tab_1_5f30e').className='';  document.getElementById('tab_1_5f30e').className='tab-pane';document.getElementById('select_tab_2_5f30e').className='';  document.getElementById('tab_2_5f30e').className='tab-pane';document.getElementById('select_tab_3_5f30e').className='active'; document.getElementById('tab_3_5f30e').className='tab-pane active';return false;">PHP</a></li></ul>
  <div class="tab-content">
    <div class="tab-pane active" id="tab_1_5f30e">
<div class="code yaml">
<pre class="yaml"><span class="co1"># app/config/config.yml</span><span class="co4">
doctrine</span>:<span class="co4">
    dbal</span>:<span class="co3">
        driver</span><span class="sy2">: </span>pdo_sqlite<span class="co3">
        path</span><span class="sy2">: </span><span class="st0">&quot;%kernel.root_dir%/sqlite.db&quot;</span><span class="co3">
        charset</span><span class="sy2">: </span>UTF8</pre>
</div>
</div>


<div class="tab-pane" id="tab_2_5f30e">
<div class="code xml">
<pre class="xml"><span class="sc-1">&lt;!-- app/config/config.xml --&gt;</span>
<span class="sc3"><span class="re1">&lt;doctrine:config</span></span>
<span class="sc3">    <span class="re0">driver</span>=<span class="st0">&quot;pdo_sqlite&quot;</span></span>
<span class="sc3">    <span class="re0">path</span>=<span class="st0">&quot;%kernel.root_dir%/sqlite.db&quot;</span></span>
<span class="sc3">    <span class="re0">charset</span>=<span class="st0">&quot;UTF-8&quot;</span></span>
<span class="sc3"><span class="re2">&gt;</span></span>
    <span class="sc-1">&lt;!-- ... --&gt;</span>
<span class="sc3"><span class="re1">&lt;/doctrine:config<span class="re2">&gt;</span></span></span></pre>
</div>
</div>


<div class="tab-pane" id="tab_3_5f30e">
<div class="code php">
<pre class="php"><span class="co1">// app/config/config.php</span>
<span class="re0">$container</span><span class="sy0">-&gt;</span><span class="me1">loadFromExtension</span><span class="br0">&#40;</span><span class="st_h">'doctrine'</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span>
    <span class="st_h">'dbal'</span> <span class="sy0">=&gt;</span> <span class="kw3">array</span><span class="br0">&#40;</span>
        <span class="st_h">'driver'</span>  <span class="sy0">=&gt;</span> <span class="st_h">'pdo_sqlite'</span><span class="sy0">,</span>
        <span class="st_h">'path'</span>    <span class="sy0">=&gt;</span> <span class="st_h">'%kernel.root_dir%/sqlite.db'</span><span class="sy0">,</span>
        <span class="st_h">'charset'</span> <span class="sy0">=&gt;</span> <span class="st_h">'UTF-8'</span><span class="sy0">,</span>
    <span class="br0">&#41;</span><span class="sy0">,</span>
<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>
</div>

  </div>
</div>

<h3 id="creando_una_clase_entity">8.1.3. Creando una clase <code>Entity</code></h3>

<p>Imagina que estás desarrollando una aplicación en la que vas a mostrar productos. Olvidándote de Doctrine y de las bases de datos, seguramente estás pensando en utilizar un objeto <code>Product</code> para representar a los productos. Crea esta clase dentro del directorio <code>Entity</code> del <em>bundle</em> <code>AcmeStoreBundle</code>:</p>

<div class="code php">
<pre class="php"><span class="co1">// src/Acme/StoreBundle/Entity/Product.php</span>
<span class="kw2">namespace</span> Acme\StoreBundle\Entity<span class="sy0">;</span>
&nbsp;
<span class="kw2">class</span> Product
<span class="br0">&#123;</span>
    <span class="kw2">protected</span> <span class="re0">$name</span><span class="sy0">;</span>
&nbsp;
    <span class="kw2">protected</span> <span class="re0">$price</span><span class="sy0">;</span>
&nbsp;
    <span class="kw2">protected</span> <span class="re0">$description</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</div>

<p>Esta clase normalmente se llama <em>"entidad"</em> o <em>"entity"</em>, lo que significa que es una clase muy sencilla que sólo se utiliza para almacenar datos. Aunque se trata de una clase muy básica, cumple su objetivo de representar a los productos de tu aplicación. No obstante, esta clase no se puede guardar en una base de datos — es sólo una clase PHP simple.</p>

<div class="admonition tip"><p><strong class="title">Truco</strong> Una vez aprendidos los conceptos fundamentales de Doctrine, podrás generar las clases de tipo entidad más fácilmente con el siguiente comando. Una vez ejecutado, Doctrine te hará varias preguntas para generar la entidad de forma interactiva:</p>

<div class="code cli">
<pre class="cli">$ php app/console doctrine:generate:entity</pre>
</div>

<p></p></div>

<h3 id="anadiendo_la_informacion_de_mapeo">8.1.4. Añadiendo la información de mapeo</h3>

<p>Trabajar con Doctrine es mucho más interesante que hacerlo directamente con la base de datos. En vez de trabajar con filas y tablas, Doctrine te permite guardar y obtener objetos enteros a partir de la información de la base de datos. El <em>truco</em> para que esto funcione consiste en <em>mapear</em> una clase PHP a una tabla de la base de datos y después, <em>mapear</em> las propiedades de la clase PHP a las columnas de esa tabla:</p>

<div class="figure" id="figure_8_1">
    <img src="/img/symfony_2_0/doctrine_image_1.png" alt="Mapeando un objeto PHP a una tabla" />

    <p class="caption"><strong>Figura 8.1</strong> Mapeando un objeto PHP a una tabla</p>
</div>


<p>Doctrine simplifica al máximo este proceso, de manera que sólo tienes que añadir algunos <em>metadatos</em> a la clase PHP para configurar cómo se <em>mapean</em> la clase <code>Product</code> y sus propiedades. Estos metadatos se pueden configurar en archivos YAML, XML o directamente mediante anotaciones en la propia clase PHP:</p>

<div class="tabbable">
  <ul class="nav nav-tabs"><li id="select_tab_1_5f42b" class="active"><a data-toggle="tab active" href="#select_tab_1_5f42b" onclick="document.getElementById('select_tab_1_5f42b').className='active'; document.getElementById('tab_1_5f42b').className='tab-pane active';document.getElementById('select_tab_2_5f42b').className='';  document.getElementById('tab_2_5f42b').className='tab-pane';document.getElementById('select_tab_3_5f42b').className='';  document.getElementById('tab_3_5f42b').className='tab-pane';return false;">PHP</a></li><li id="select_tab_2_5f42b"><a data-toggle="tab" href="#select_tab_2_5f42b" onclick="document.getElementById('select_tab_1_5f42b').className='';  document.getElementById('tab_1_5f42b').className='tab-pane';document.getElementById('select_tab_2_5f42b').className='active'; document.getElementById('tab_2_5f42b').className='tab-pane active';document.getElementById('select_tab_3_5f42b').className='';  document.getElementById('tab_3_5f42b').className='tab-pane';return false;">YAML</a></li><li id="select_tab_3_5f42b"><a data-toggle="tab" href="#select_tab_3_5f42b" onclick="document.getElementById('select_tab_1_5f42b').className='';  document.getElementById('tab_1_5f42b').className='tab-pane';document.getElementById('select_tab_2_5f42b').className='';  document.getElementById('tab_2_5f42b').className='tab-pane';document.getElementById('select_tab_3_5f42b').className='active'; document.getElementById('tab_3_5f42b').className='tab-pane active';return false;">XML</a></li></ul>
  <div class="tab-content">
    <div class="tab-pane active" id="tab_1_5f42b">
<div class="code php">
<pre class="php"><span class="co1">// src/Acme/StoreBundle/Entity/Product.php</span>
<span class="kw2">namespace</span> Acme\StoreBundle\Entity<span class="sy0">;</span>
&nbsp;
<span class="kw2">use</span> Doctrine\ORM\Mapping <span class="kw1">as</span> ORM<span class="sy0">;</span>
&nbsp;
<span class="co4">/**
 * @ORM\Entity
 * @ORM\Table(name=&quot;product&quot;)
 */</span>
<span class="kw2">class</span> Product
<span class="br0">&#123;</span>
    <span class="co4">/**
     * @ORM\Id
     * @ORM\Column(type=&quot;integer&quot;)
     * @ORM\GeneratedValue(strategy=&quot;AUTO&quot;)
     */</span>
    <span class="kw2">protected</span> <span class="re0">$id</span><span class="sy0">;</span>
&nbsp;
    <span class="co4">/**
     * @ORM\Column(type=&quot;string&quot;, length=100)
     */</span>
    <span class="kw2">protected</span> <span class="re0">$name</span><span class="sy0">;</span>
&nbsp;
    <span class="co4">/**
     * @ORM\Column(type=&quot;decimal&quot;, scale=2)
     */</span>
    <span class="kw2">protected</span> <span class="re0">$price</span><span class="sy0">;</span>
&nbsp;
    <span class="co4">/**
     * @ORM\Column(type=&quot;text&quot;)
     */</span>
    <span class="kw2">protected</span> <span class="re0">$description</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</div>
</div>


<div class="tab-pane" id="tab_2_5f42b">
<div class="code yaml">
<pre class="yaml"><span class="co1"># src/Acme/StoreBundle/Resources/config/doctrine/Product.orm.yml</span><span class="co4">
Acme\StoreBundle\Entity\Product</span>:<span class="co3">
    type</span><span class="sy2">: </span>entity<span class="co3">
    table</span><span class="sy2">: </span>product<span class="co4">
    id</span>:<span class="co4">
        id</span>:<span class="co3">
            type</span><span class="sy2">: </span>integer<span class="co3">
            generator</span><span class="sy2">: </span><span class="br0">&#123;</span> strategy<span class="sy2">: </span>AUTO <span class="br0">&#125;</span><span class="co4">
    fields</span>:<span class="co4">
        name</span>:<span class="co3">
            type</span><span class="sy2">: </span>string<span class="co3">
            length</span><span class="sy2">: </span><span class="nu0">100</span><span class="co4">
        price</span>:<span class="co3">
            type</span><span class="sy2">: </span>decimal<span class="co3">
            scale</span><span class="sy2">: </span><span class="nu0">2</span><span class="co4">
        description</span>:<span class="co3">
            type</span><span class="sy2">: </span>text</pre>
</div>
</div>


<div class="tab-pane" id="tab_3_5f42b">
<div class="code xml">
<pre class="xml"><span class="sc-1">&lt;!-- src/Acme/StoreBundle/Resources/config/doctrine/Product.orm.xml --&gt;</span>
<span class="sc3"><span class="re1">&lt;doctrine-mapping</span> <span class="re0">xmlns</span>=<span class="st0">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping&quot;</span></span>
<span class="sc3">      <span class="re0">xmlns:xsi</span>=<span class="st0">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span>
<span class="sc3">      <span class="re0">xsi:schemaLocation</span>=<span class="st0">&quot;http://doctrine-project.org/schemas/orm/doctrine-mapping</span>
<span class="sc3">                    http://doctrine-project.org/schemas/orm/doctrine-mapping.xsd&quot;</span><span class="re2">&gt;</span></span>
&nbsp;
    <span class="sc3"><span class="re1">&lt;entity</span> <span class="re0">name</span>=<span class="st0">&quot;Acme\StoreBundle\Entity\Product&quot;</span> <span class="re0">table</span>=<span class="st0">&quot;product&quot;</span><span class="re2">&gt;</span></span>
        <span class="sc3"><span class="re1">&lt;id</span> <span class="re0">name</span>=<span class="st0">&quot;id&quot;</span> <span class="re0">type</span>=<span class="st0">&quot;integer&quot;</span> <span class="re0">column</span>=<span class="st0">&quot;id&quot;</span><span class="re2">&gt;</span></span>
            <span class="sc3"><span class="re1">&lt;generator</span> <span class="re0">strategy</span>=<span class="st0">&quot;AUTO&quot;</span> <span class="re2">/&gt;</span></span>
        <span class="sc3"><span class="re1">&lt;/id<span class="re2">&gt;</span></span></span>
        <span class="sc3"><span class="re1">&lt;field</span> <span class="re0">name</span>=<span class="st0">&quot;name&quot;</span> <span class="re0">column</span>=<span class="st0">&quot;name&quot;</span> <span class="re0">type</span>=<span class="st0">&quot;string&quot;</span> <span class="re0">length</span>=<span class="st0">&quot;100&quot;</span> <span class="re2">/&gt;</span></span>
        <span class="sc3"><span class="re1">&lt;field</span> <span class="re0">name</span>=<span class="st0">&quot;price&quot;</span> <span class="re0">column</span>=<span class="st0">&quot;price&quot;</span> <span class="re0">type</span>=<span class="st0">&quot;decimal&quot;</span> <span class="re0">scale</span>=<span class="st0">&quot;2&quot;</span> <span class="re2">/&gt;</span></span>
        <span class="sc3"><span class="re1">&lt;field</span> <span class="re0">name</span>=<span class="st0">&quot;description&quot;</span> <span class="re0">column</span>=<span class="st0">&quot;description&quot;</span> <span class="re0">type</span>=<span class="st0">&quot;text&quot;</span> <span class="re2">/&gt;</span></span>
    <span class="sc3"><span class="re1">&lt;/entity<span class="re2">&gt;</span></span></span>
<span class="sc3"><span class="re1">&lt;/doctrine-mapping<span class="re2">&gt;</span></span></span></pre>
</div>
</div>

  </div>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> En un mismo <em>bundle</em> no puedes mezclar diferentes formas de definir los metadatos. Si utilizas por ejemplo YAML en una entidad, no puedes utilizar anotaciones PHP en otras entidades.</p></div>

<div class="admonition tip"><p><strong class="title">Truco</strong> El nombre de la tabla es opcional y si lo omites, se genera automáticamente en función del nombre de la clase PHP.</p></div>

<p>Doctrine incluye soporte para una gran variedad de tipos de campo, cada uno con sus propias opciones, tal y como se explicará más adelante en este mismo capítulo.</p>

<p>También puedes consultar la <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/basic-mapping.html">documentación oficial de Doctrine sobre el mapeo</a>. Ten en cuenta que en la documentación de Doctrine no se explica que si utilizas anotaciones, tienes que prefijarlas todas con la cadena <code>ORM\</code> (por ejemplo, <code>ORM\Column(...)</code>). Igualmente, no te olvides de añadir la declaración <code>use Doctrine\ORM\Mapping as ORM;</code> al principio de tus clases para importar el prefijo <code>ORM\</code>.</p>

<div class="admonition caution"><p><strong class="title">Advertencia</strong> Ten cuidado de que el nombre de tu clase o el de tus propiedades no coincida con alguna de las palabras clave de SQL (como por ejemplo <code>group</code> o <code>user</code>). Si tu clase se llama <code>Group</code> y no indicas un nombre de tabla, se utilizará automáticamente el valor <code>group</code>, lo que provocará un error en algunos tipos de bases de datos.</p>

<p>Consulta la sección <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/basic-mapping.html#quoting-reserved-words">Quoting reserved words</a> de la documentación de Doctrine para conocer la lista completa de palabras reservadas.</p>

<p>Si lo prefieres, también puedes solucionar este problema modificando el nombre generado para la tabla o para las columnas. Consulta las secciones <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/basic-mapping.html#persistent-classes">persistent classes</a> y <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/reference/basic-mapping.html#property-mapping">property mapping</a> de la documentación de Doctrine.</p></div>

<div class="admonition note"><p><strong class="title">Nota</strong> Si en tu aplicación utilizas alguna otra librería o aplicación con anotaciones (por ejemplo <em>Doxygen</em>), añade la anotación <code>@IgnoreAnnotation</code> en la clase para indicar qué anotaciones de Symfony se deben ignorar.</p>

<p>Para evitar por ejemplo que la anotación <code>@fn</code> lance una excepción, añade lo siguiente:</p>

<div class="code php">
<pre class="php"><span class="co4">/**
 * @IgnoreAnnotation(&quot;fn&quot;)
 */</span>
<span class="kw2">class</span> Product
<span class="co1">// ...</span></pre>
</div>

<p></p></div>

<h3 id="generando_getters_y_setters">8.1.5. Generando <em>getters</em> y <em>setters</em></h3>

<p>Doctrine ya sabe cómo persistir los objetos de tipo <code>Product</code> en la base de datos, pero esa clase no es muy útil por el momento. Como <code>Product</code> es una clase PHP normal y corriente, es necesario crear métodos <em>getters</em> y <em>setters</em> (<code>getName()</code>, <code>setName()</code>, etc.) para poder acceder a sus propiedades (porque son de tipo <code>protected</code>). Como esto es bastante habitual, existe un comando para que Doctrine añada estos métodos automáticamente:</p>

<div class="code cli">
<pre class="cli">$ php app/console doctrine:generate:entities Acme/StoreBundle/Entity/Product</pre>
</div>

<p>Este comando asegura que la clase <code>Product</code> contiene todos los <em>getters</em> y <em>setters</em> necesarios. Puedes ejecutar de forma segura este comando una y otra vez, ya que los <em>getters</em> y <em>setters</em> sólo se generan si no existen (no se borran los métodos existentes).</p>

<div class="admonition caution"><p><strong class="title">Advertencia</strong> Los <em>getters</em> y <em>setters</em> que genera Doctrine son muy básicos, por lo que tendrás que ajustar su código a las necesidades de tu aplicación.</p></div>

<div class="admonition sidebar"><p><strong class="title"> Más sobre el comando <code>doctrine:generate:entities</code></strong> Utilizando el comando <code>doctrine:generate:entities</code> puedes:</p>

<ul>
<li>generar <em>getters</em> y <em>setters</em></li>
<li>generar las clases de tipo <code>Repository</code> configuradas con la anotación <code>@ORM\Entity(repositoryClass="...")</code>,</li>
<li>generar el constructor adecuado para relaciones <code>1:n</code> (<em>uno a muchos</em>) y <code>n:m</code> (<em>muchos a muchos</em>).</li>
</ul>

<p>Para evitar problemas, el comando <code>doctrine:generate:entities</code> guarda una copia de seguridad del archivo <code>Product.php</code> original en el archivo <code>Product.php~</code> (la diferencia está en el carácter <code>~</code> al final del nombre). En ocasiones esta copia de seguridad puede provocar en la aplicación errores de tipo <em>"Cannot redeclare class"</em>. Si se producen esos errores, puedes borra este archivo sin problemas. También puedes añadir la opción <code>--no-backup</code> al comando anterior para no generar estas copias de seguridad.</p>

<p>Por último, ten en cuenta que <strong>no</strong> es obligatorio usar este comando, ya que Doctrine <strong>no</strong> se basa en la generación automática de código. Al igual que para cualquier otra clase PHP, sólo debes tener en cuenta que existan <em>getters</em> y <em>setters</em> para las propiedades <code>protected</code> y <code>private</code> de la calse. Como es habitual que las propiedades de las entidades de Doctrine sean <code>protected</code>, se creó este comando para ahorrarte trabajo.</p></div>

<p>También puedes generar a la vez todas las entidades de un <em>bundle</em> (es decir, cualquier clase PHP con información de <em>mapeo</em> de Doctrine) o de un espacio de nombres:</p>

<div class="code cli">
<pre class="cli">$ php app/console doctrine:generate:entities AcmeStoreBundle
$ php app/console doctrine:generate:entities Acme</pre>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> A Doctrine no le importa si tus propiedades son <code>protected</code> o <code>private</code>, o si una propiedad tiene o no un <em>getter</em> o <em>setter</em> definido. Pero estos métodos sí que son necesarios para que puedas interactuar con el objeto PHP que almacena la información.</p></div>

<h3 id="creando_las_tablas_de_la_base_de_datos_el_esquema">8.1.6. Creando las tablas de la base de datos (el esquema)</h3>

<p>Aunque tienes una clase <code>Product</code> utilizable con información de <em>mapeo</em> para que Doctrine sepa persistirla, todavía no tienes su correspondiente tabla <code>product</code> en la base de datos. Afortunadamente, Doctrine puede crear automáticamente todas las tablas necesarias en la base de datos (una para cada entidad conocida de tu aplicación). Para ello, ejecuta el siguiente comando:</p>

<div class="code cli">
<pre class="cli">$ php app/console doctrine:schema:update --force</pre>
</div>

<div class="admonition tip"><p><strong class="title">Truco</strong> En realidad, este comando es muy poderoso. Internamente compara la estructura que debería tener tu base de datos (según la información de <em>mapeo</em> de tus entidades) con la estructura que realmente tiene y genera las sentencias SQL necesarias para actualizar la estructura de la base de datos.</p>

<p>En otras palabras, si añades una nueva propiedad a la clase <code>Product</code> y ejecutas este comando otra vez, se genera una sentencia de tipo <code>ALTER TABLE</code> para añadir la nueva columna a la tabla <code>product</code> existente.</p>

<p>Una forma aún mejor para aprovechar esta funcionalidad son las <strong>migraciones</strong>, que permiten generar estas instrucciones SQL y almacenarlas en unas clases PHP especiales que puedes ejecutar en tu servidor de producción para aplicar los cambios en las bases de datos.</p></div>

<p>Después de ejecutar este comando, la base de datos cuenta ahora con una tabla llamada <code>product</code> completamente funcional, y sus columnas coinciden con los metadatos que has especificado en la clase <code>Product</code>.</p>

<h3 id="persistiendo_objetos_en_la_base_de_datos">8.1.7. Persistiendo objetos en la base de datos</h3>

<p>Ahora que tienes <em>mapeada</em> una entidad <code>Product</code> y su tabla <code>product</code> correspondiente, ya puedes persistir la información en la base de datos. De hecho, persistir información dentro de un controlador es bastante sencillo. Añade el siguiente método al controlador <code>DefaultController</code> del <em>bundle</em>:</p>

<div class="code php">
<pre class="php"><span class="co1">// src/Acme/StoreBundle/Controller/DefaultController.php</span>
&nbsp;
<span class="co1">// ...</span>
<span class="kw2">use</span> Acme\StoreBundle\Entity\Product<span class="sy0">;</span>
<span class="kw2">use</span> Symfony\Component\HttpFoundation\Response<span class="sy0">;</span>
&nbsp;
<span class="kw2">public</span> <span class="kw2">function</span> createAction<span class="br0">&#40;</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="re0">$product</span> <span class="sy0">=</span> <span class="kw2">new</span> Product<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">$product</span><span class="sy0">-&gt;</span><span class="me1">setName</span><span class="br0">&#40;</span><span class="st_h">'A Foo Bar'</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">$product</span><span class="sy0">-&gt;</span><span class="me1">setPrice</span><span class="br0">&#40;</span><span class="st_h">'19.99'</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">$product</span><span class="sy0">-&gt;</span><span class="me1">setDescription</span><span class="br0">&#40;</span><span class="st_h">'Lorem ipsum dolor'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="re0">$em</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getDoctrine</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">getManager</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">$em</span><span class="sy0">-&gt;</span><span class="me1">persist</span><span class="br0">&#40;</span><span class="re0">$product</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">$em</span><span class="sy0">-&gt;</span><span class="kw3">flush</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">return</span> <span class="kw2">new</span> Response<span class="br0">&#40;</span><span class="st_h">'Created product id '</span><span class="sy0">.</span><span class="re0">$product</span><span class="sy0">-&gt;</span><span class="me1">getId</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> Si estás siguiendo este capítulo probando los ejemplos de código en tu propio ordenador, no olvides crear una ruta que apunte a esta acción para poder probarla en el navegador.</p></div>

<div class="admonition tip"><p><strong class="title">Truco</strong> En este capítulo se utiliza Doctrine directamente a través del método
<code>getDoctrine()</code> de los controladores. En realidad, este método es un atajo para
obtener el servicio llamado <code>doctrine</code>. Si quieres usar Doctrine en cualquier
otra parte que no sea un controlador, puedes inyectar ese servicio.</p></div>

<p>Veamos detenidamente cómo funciona el ejemplo anterior:</p>

<ul>
<li><strong>Líneas 9-12</strong> En esta sección, creas una instancia y trabajas con el objeto <code>$product</code> como harías con cualquier otro objeto PHP normal.</li>
<li><strong>Línea 14</strong> Esta línea obtiene el <em>"entity manager"</em> o <em>gestor de entidades</em> de Doctrine, que se utiliza para persistir y recuperar objetos hacia y desde la base de datos.</li>
<li><strong>Línea 15</strong> El método <code>persist()</code> le dice a Doctrine que debe persistir el objeto <code>$product</code>, pero todavía no se genera (y por tanto, tampoco se ejecuta) la sentencia SQL correspondiente.</li>
<li><strong>Línea 16</strong> Cuando se llama al método <code>flush()</code>, Doctrine examina todos los objetos que está gestionando para ver si es necesario persistirlos en la base de datos. En este ejemplo, el objeto <code>$product</code> aún no se ha persistido, por lo que el gestor de la entidad ejecuta una consulta de tipo <code>INSERT</code> y crea una fila en la tabla <code>product</code>.</li>
</ul>

<div class="admonition note"><p><strong class="title">Nota</strong> Como Doctrine conoce todas tus entidades, cuando se llama al método <code>flush()</code>, calcula todos los cambios que debe hacer y ejecuta las sentencias más eficientes posibles. Si persistes por ejemplo 100 objetos de tipo <code>Product</code> y después llamas al método <code>flush()</code>, Doctrine prepara una sola sentencia SQL y la reutiliza para cada inserción. Esta forma de trabajar se corresponde con el patrón de diseño llamado <em>Unit of Work</em> y se utiliza porque es muy rápido y eficiente.</p></div>

<p>Al crear o actualizar objetos, el flujo de trabajo siempre es el mismo. En la siguiente sección, verás cómo Doctrine es lo suficientemente inteligente como para detectar si la consulta debe ser de tipo <code>UPDATE</code> en vez de <code>INSERT</code> si el registro ya existe en la base de datos.</p>

<div class="admonition tip"><p><strong class="title">Truco</strong> Doctrine dispone de una librería para cargar de forma automática datos de prueba como los que utilizan los tests (estos datos se suelen llamar <em>fixtures</em> o <em>datos de prueba</em>). Esta librería está disponible en Symfony2 a través del <em>bundle</em> <code>DoctrineFixturesBundle</code>.</p></div>

<h3 id="buscando_objetos_en_la_base_de_datos">8.1.8. Buscando objetos en la base de datos</h3>

<p>Buscar información de la base de datos y recuperar en forma de objeto es todavía más fácil. Imagina que has configurado una ruta de la aplicación para mostrar la información de un producto a partir del valor de su <code>id</code>. El código del controlador correspondiente podría ser el siguiente:</p>

<div class="code php">
<pre class="php"><span class="kw2">public</span> <span class="kw2">function</span> showAction<span class="br0">&#40;</span><span class="re0">$id</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="re0">$product</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getDoctrine</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
        <span class="sy0">-&gt;</span><span class="me1">getRepository</span><span class="br0">&#40;</span><span class="st_h">'AcmeStoreBundle:Product'</span><span class="br0">&#41;</span>
        <span class="sy0">-&gt;</span><span class="me1">find</span><span class="br0">&#40;</span><span class="re0">$id</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$product</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">throw</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">createNotFoundException</span><span class="br0">&#40;</span>
            <span class="st_h">'No product found for id '</span><span class="sy0">.</span><span class="re0">$id</span>
        <span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="co1">// ... (pasar el objeto $product a una plantilla)</span>
<span class="br0">&#125;</span></pre>
</div>

<div class="admonition tip"><p><strong class="title">Truco</strong> Si utilizas un concepto avanzado llamado <code>@ParamConverter</code> puedes conseguir el mismo resultado que el código anterior sin tener que escribir una sola línea de código. Consulta la documentación del <em>bundle</em> <code>FrameworkExtraBundle</code> para obtener más información.</p></div>

<p>Al realizar una consulta por un determinado objeto, Doctrine siempre utiliza lo que se conoce como <em>"repositorio"</em>. Estos <em>repositorios</em> son como clases PHP cuyo trabajo consiste en ayudarte a buscar las entidades de una determinada clase. Puedes acceder al repositorio de la entidad de una clase mediante el código:</p>

<div class="code php">
<pre class="php"><span class="re0">$repository</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getDoctrine</span><span class="br0">&#40;</span><span class="br0">&#41;</span>
    <span class="sy0">-&gt;</span><span class="me1">getRepository</span><span class="br0">&#40;</span><span class="st_h">'AcmeStoreBundle:Product'</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> La cadena <code>AcmeStoreBundle:Product</code> es un atajo que puedes utilizar en cualquier lugar de Doctrine en vez del nombre completo de la clase de la entidad (en este caso, <code>Acme\StoreBundle\Entity\Product</code>). Este atajo funciona siempre que tu entidad se encuentre bajo el espacio de nombres <code>Entity</code> de algún <em>bundle</em>.</p></div>

<p>Una vez que obtienes el repositorio, tienes acceso a todo tipo de métodos útiles:</p>

<div class="code php">
<pre class="php"><span class="co1">// consulta por la clave principal (generalmente 'id')</span>
<span class="re0">$product</span> <span class="sy0">=</span> <span class="re0">$repository</span><span class="sy0">-&gt;</span><span class="me1">find</span><span class="br0">&#40;</span><span class="re0">$id</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// métodos con nombres dinámicos para buscar un valor en función de alguna columna</span>
<span class="re0">$product</span> <span class="sy0">=</span> <span class="re0">$repository</span><span class="sy0">-&gt;</span><span class="me1">findOneById</span><span class="br0">&#40;</span><span class="re0">$id</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$product</span> <span class="sy0">=</span> <span class="re0">$repository</span><span class="sy0">-&gt;</span><span class="me1">findOneByName</span><span class="br0">&#40;</span><span class="st_h">'foo'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// obtiene todos los productos</span>
<span class="re0">$products</span> <span class="sy0">=</span> <span class="re0">$repository</span><span class="sy0">-&gt;</span><span class="me1">findAll</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// busca productos basándose en el valor de una columna</span>
<span class="re0">$products</span> <span class="sy0">=</span> <span class="re0">$repository</span><span class="sy0">-&gt;</span><span class="me1">findByPrice</span><span class="br0">&#40;</span><span class="nu19">19.99</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<div class="admonition note"><p><strong class="title">Nota</strong> Por supuesto, también puedes realizar consultas más complejas, tal y como se explicará más adelante.</p></div>

<p>También puedes utilizar los métodos <code>findBy</code> y <code>findOneBy</code> para obtener objetos  en función de varias condiciones:</p>

<div class="code php">
<pre class="php"><span class="co1">// busca un producto con ese nombre y ese precio</span>
<span class="re0">$product</span> <span class="sy0">=</span> <span class="re0">$repository</span><span class="sy0">-&gt;</span><span class="me1">findOneBy</span><span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
    <span class="st_h">'name'</span>  <span class="sy0">=&gt;</span> <span class="st_h">'foo'</span><span class="sy0">,</span> <span class="st_h">'price'</span> <span class="sy0">=&gt;</span> <span class="nu19">19.99</span>
<span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="co1">// obtiene todos los productos con un nombre determinado</span>
<span class="co1">// y ordena los resultados por precio</span>
<span class="re0">$product</span> <span class="sy0">=</span> <span class="re0">$repository</span><span class="sy0">-&gt;</span><span class="me1">findBy</span><span class="br0">&#40;</span>
    <span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'name'</span>  <span class="sy0">=&gt;</span> <span class="st_h">'foo'</span><span class="br0">&#41;</span><span class="sy0">,</span>
    <span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'price'</span> <span class="sy0">=&gt;</span> <span class="st_h">'ASC'</span><span class="br0">&#41;</span>
<span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<div class="admonition tip"><p><strong class="title">Truco</strong> En la esquina inferior derecha de la barra de depuración web, puedes ver cuántas consultas a la base de datos fueron necesarias para renderizar esa página.</p>

<div class="figure" id="figure_8_2">
    <img src="/img/symfony_2_0/doctrine_web_debug_toolbar.png" alt="Información de Doctrine en la barra de depuración web" />

    <p class="caption"><strong>Figura 8.2</strong> Información de Doctrine en la barra de depuración web</p>
</div>


<p>Si pinchas sobre el icono, se abrirá el <em>profiler</em> de Symfony y se mostrarán las consultas exactas que se hicieron.</p></div>

<h3 id="actualizando_un_objeto">8.1.9. Actualizando un objeto</h3>

<p>Una vez que hayas obtenido un objeto de Doctrine, actualizarlo es relativamente fácil. Supongamos que la aplicación dispone de una ruta que actualiza la información del producto cuyo <code>id</code> se indica:</p>

<div class="code php">
<pre class="php"><span class="kw2">public</span> <span class="kw2">function</span> updateAction<span class="br0">&#40;</span><span class="re0">$id</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="re0">$em</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getDoctrine</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">getManager</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">$product</span> <span class="sy0">=</span> <span class="re0">$em</span><span class="sy0">-&gt;</span><span class="me1">getRepository</span><span class="br0">&#40;</span><span class="st_h">'AcmeStoreBundle:Product'</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">find</span><span class="br0">&#40;</span><span class="re0">$id</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">if</span> <span class="br0">&#40;</span><span class="sy0">!</span><span class="re0">$product</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
        <span class="kw1">throw</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">createNotFoundException</span><span class="br0">&#40;</span>
            <span class="st_h">'No product found for id '</span><span class="sy0">.</span><span class="re0">$id</span>
        <span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="re0">$product</span><span class="sy0">-&gt;</span><span class="me1">setName</span><span class="br0">&#40;</span><span class="st_h">'New product name!'</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="re0">$em</span><span class="sy0">-&gt;</span><span class="kw3">flush</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">return</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">redirect</span><span class="br0">&#40;</span><span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">generateUrl</span><span class="br0">&#40;</span><span class="st_h">'homepage'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
</div>

<p>Actualizar un objeto requiere de tres pasos:</p>

<ol>
<li>Obtener el objeto utilizando Doctrine.</li>
<li>Modificar el objeto.</li>
<li>Invocar al método <code>flush()</code> del <em>entity manager</em>.</li>
</ol>

<p>Observa que no hace falta llamar al método <code>$em-&gt;persist($product)</code>. Este método sive para avisar a Doctrine de que vas a manipular un determinado objeto. En este caso, como el objeto <code>$product</code> lo has obtenido mediante una consulta a Doctrine, este ya sabe que debe estar atento a los posibles cambios del objeto.</p>

<h3 id="eliminando_un_objeto">8.1.10.  Eliminando un objeto</h3>

<p>Eliminar objetos es un proceso similar, pero requiere invocar el método <code>remove()</code> del <em>entity manager</em>:</p>

<div class="code php">
<pre class="php"><span class="re0">$em</span><span class="sy0">-&gt;</span><span class="me1">remove</span><span class="br0">&#40;</span><span class="re0">$product</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$em</span><span class="sy0">-&gt;</span><span class="kw3">flush</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
</div>

<p>Como puede que imagines, el método <code>remove()</code> avisa a Doctrine que quieres eliminar esa entidad de la base de datos, pero no la borra realmente. La consulta <code>DELETE</code> correspondiente no se genera ni se ejecuta hasta que no se invoca el método <code>flush()</code>.</p>



            <div class="module module-ad module-ad-responsive module-ad-bottom">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-1491000300253750"
         data-ad-slot="3770792827"
         data-ad-format="auto"></ins>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>

    
    <div id="book-pager">
        <ul class="row pager">
            <li class="col-xs-6 previous ">
                                    <a href="../capitulo_8.html">
                        <strong>&larr; Anterior</strong>
                        <small>Capítulo 8. La base de datos y Doctrine</small>
                    </a>
                            </li>

            <li class="col-xs-6 next ">
                                    <a href="../capitulo_8/buscando_objetos.html">
                        <strong>Siguiente &rarr;</strong>
                        <small>8.2. Buscando objetos</small>
                    </a>
                            </li>
        </ul>
    </div>

                        </div>

                    <div id="sidebar" class="col-sm-3">
                        
            <div class="module module-share">
        <h3>Compartir</h3>
        <ul>
    <li><a id="share_twitter" href="#" title="Compartir en Twitter">Twitter</a></li>
    <li><a id="share_facebook" href="#" title="Compartir en Facebook">Facebook</a></li>
    <li><a id="share_google" href="#" title="Compartir en Google+">Google+</a></li>
</ul>

<script type="text/javascript">
var title    = '{{ item_social_title }}';
var page_url = encodeURIComponent(window.location);
var options  = 'menubar=no,toolbar=no,resizable=yes,scrollbars=no,width=640,height=350';
var services = {
    share_twitter:  'https://twitter.com/share?text=' + title + '&lang=es',
    share_facebook: 'http://www.facebook.com/sharer.php?u=' + page_url + '&t=' + title,
    share_google:   'https://plus.google.com/share?url=' + page_url + '&hl=es'
};

for (var id in services) {
    if (services.hasOwnProperty(id)) {
        document.getElementById(id).href = services[id];
        document.getElementById(id).onclick = function(a) {
            a = a || window.event;
            a = a.target || a.srcElement;

            ga('send', 'social', {
                'socialNetwork' : a.id.substr(6),
                'socialAction'  : 'share',
                'socialTarget'  : window.location
            });

            window.open(services[a.id], a.title, options);

            return false;
        };
    }
}
</script>

    </div>

            <div class="module module-ad module-ad-responsive module-ad-sidebar">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-1491000300253750"
         data-ad-slot="3770792827"
         data-ad-format="auto"></ins>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>

    
    <div id="book-toc" class="module">
        <a id="indice"></a>

        <h3>Indice de contenidos</h3>
        <ul class="toc text-links">
                                            <li class="level-1">
                <span>1.</span> <a href="../capitulo_1.html"> Symfony2 y los fundamentos de HTTP</a>
            </li>
                                                                                                                            <li class="level-1">
                <span>2.</span> <a href="../capitulo_2.html"> De PHP a Symfony2</a>
            </li>
                                                                                                            <li class="level-1">
                <span>3.</span> <a href="../capitulo_3.html"> Instalando y configurando Symfony2</a>
            </li>
                                                                                            <li class="level-1">
                <span>4.</span> <a href="../capitulo_4.html"> Creando páginas en Symfony2</a>
            </li>
                                                                                                                                                            <li class="level-1">
                <span>5.</span> <a href="../capitulo_5.html"> El controlador</a>
            </li>
                                                                                                                                                                                                            <li class="level-1">
                <span>6.</span> <a href="../capitulo_6.html"> El enrutamiento</a>
            </li>
                                                                                                                                                                                            <li class="level-1">
                <span>7.</span> <a href="../capitulo_7.html"> Creando y utilizando plantillas</a>
            </li>
                                                                                                                                                                                                                                                                            <li class="level-1 ">
                <a href="../capitulo_8.html">
                    <span>Capítulo 8.</span> La base de datos y Doctrine
                </a>
            </li>
                                            <li class="level-2 active">
                <a href="../capitulo_8/un_ejemplo_sencillo.html">
                    <span>8.1.</span> Un ejemplo sencillo
                </a>
            </li>
                                            <li class="level-2 ">
                <a href="../capitulo_8/buscando_objetos.html">
                    <span>8.2.</span> Buscando objetos
                </a>
            </li>
                                            <li class="level-2 ">
                <a href="../capitulo_8/relaciones_y_asociaciones_de_entidades.html">
                    <span>8.3.</span> Relaciones y asociaciones de entidades
                </a>
            </li>
                                            <li class="level-2 ">
                <a href="../capitulo_8/configuracion.html">
                    <span>8.4.</span> Configuración
                </a>
            </li>
                                            <li class="level-2 ">
                <a href="../capitulo_8/lifecycle_callbacks.html">
                    <span>8.5.</span> Lifecycle Callbacks 
                </a>
            </li>
                                            <li class="level-2 ">
                <a href="../capitulo_8/referencia_de_los_tipos_de_campo_de_doctrine.html">
                    <span>8.6.</span> Referencia de los tipos de campo de Doctrine
                </a>
            </li>
                                            <li class="level-2 ">
                <a href="../capitulo_8/resumen.html">
                    <span>8.7.</span> Resumen
                </a>
            </li>
                                            <li class="level-1">
                <span>9.</span> <a href="../capitulo_9.html"> La base de datos y Propel</a>
            </li>
                                            <li class="level-1">
                <span>10.</span> <a href="../capitulo_10.html"> Tests unitarios y funcionales</a>
            </li>
                                                                                                                                            <li class="level-1">
                <span>11.</span> <a href="../capitulo_11.html"> Validación</a>
            </li>
                                                                                                                                                                                            <li class="level-1">
                <span>12.</span> <a href="../capitulo_12.html"> Formularios</a>
            </li>
                                                                                                                                                                                                                                                                            <li class="level-1">
                <span>13.</span> <a href="../capitulo_13.html"> Seguridad</a>
            </li>
                                                                                                                                                                                                                                            <li class="level-1">
                <span>14.</span> <a href="../capitulo_14.html"> La caché de HTTP</a>
            </li>
                                                                                                                                                            <li class="level-1">
                <span>15.</span> <a href="../capitulo_15.html"> Internacionalización</a>
            </li>
                                                                                                                                                                                                                            <li class="level-1">
                <span>16.</span> <a href="../capitulo_16.html"> El contenedor de servicios</a>
            </li>
                                                                                                                                                                                                            <li class="level-1">
                <span>17.</span> <a href="../capitulo_17.html"> Mejorando el rendimiento</a>
            </li>
                                                                                                            <li class="level-1">
                <span>18.</span> <a href="../capitulo_18.html"> El interior de Symfony2</a>
            </li>
                                                                                                            <li class="level-1">
                <span>19.</span> <a href="../capitulo_19.html"> La API estable de Symfony2</a>
            </li>
                        </ul>
    </div>
                    </div>
                            </div>

            <div id="footer">
                <div class="row">
                    <div class="col-xs-12 col-sm-9">
                        &copy; 2015 LibrosWeb.es
                        <a href="/sitio/contacto">Contacto</a>
                        <a href="https://plus.google.com/+librosweb">Novedades</a>
                        <a href="/sitio/condiciones">Condiciones</a>
                        <a href="/sitio/privacidad">Privacidad</a>
                    </div>
                    <div class="col-xs-12 col-sm-3 uptime">
                        3.111 días online
                    </div>
                </div>
            </div>

        </div>

                                    <script src="/js/app.js"></script>
            
            <script type="text/javascript">
                console.log($(window).width());
            </script>
            </body>
</html>
