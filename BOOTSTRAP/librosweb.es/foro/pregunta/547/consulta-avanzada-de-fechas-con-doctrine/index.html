<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml" xml:lang="es" lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <title>Consulta avanzada de fechas con Doctrine</title>
                                    <link rel="stylesheet" href="/css/app.css" />
                        <script type="text/javascript">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-82842-2', 'librosweb.es');
            ga('require', 'displayfeatures');
            ga('send', 'pageview');
        </script>
                        <link rel="apple-touch-icon" type="image/png" href="/apple-touch-icon.png">
        <link rel="apple-touch-icon-precomposed" type="image/png" href="/apple-touch-icon.png">
        <meta name="apple-mobile-web-app-title" content="LibrosWeb">
        <link rel="shortcut icon" type="image/png" href="/favicon.png">
        <meta name="site-version" content="a7f65a4">
                <link rel="publisher" href="http://plus.google.com/112008023125011571577">
                                                <meta name="twitter:site" content="@librosweb">
                <link rel="search" type="application/opensearchdescription+xml" href="http://librosweb.es/opensearch/documentation.xml" title="LibrosWeb">
                <meta property="fb:page_id" content="437758756273955">
                <meta property="fb:app_id" content="437758756273955">
        <meta property="og:type" content="website">
        <meta property="og:title" content="Consulta avanzada de fechas con Doctrine">
        <meta property="og:image" content="http://www.gravatar.com/avatar/9f219b4dfaa677bfd0f47753c02d5126.png?s=200">
                <meta name="msapplication-TileColor" content="#CC1414">
        <meta name="application-name" content="LibrosWeb">
        <meta name="msapplication-tooltip" content="Libros y tutoriales sobre HTML, CSS, JavaScript, PHP y otras tecnologías web.">
    </head>

    <body id="p-4-2" class="forum forum_discussion"><script type="text/javascript">
//<![CDATA[
try{(function(a){var b="http://",c="librosweb.es",d="/cdn-cgi/cl/",e="img.gif",f=new a;f.src=[b,c,d,e].join("")})(Image)}catch(e){}
//]]>
</script>
        <div class="content-background"></div>

        <div id="header">
            <div class="navbar navbar-default navbar-static-top">
              <div class="container">
                <div class="navbar-header">
                  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#header-menu">
                    <span class="sr-only">Desplegar menú</span>
                    <i class="fa fa-menu"></i>
                  </button>
                  <a class="navbar-brand" href="/" title="LibrosWeb.es">
                      <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 132 32" preserveAspectRatio="xMinYMin meet">
<g fill="#CC1414" transform="translate(-21.738 -21.148)">
<path d="m24.062 23.486v28h9.64v-5h-4.04v-23h-5.6"/>
<path d="m40.796 23.486h-5.6v28h5.6v-28"/>
<path d="m53.932 37.006c1.48-0.56 2.32-1.76 2.32-4.16v-4.16c0-3.48-1.72-5.2-5.2-5.2h-8.24v28h8.32c3.48 0 5.2-1.72 5.2-5.2v-5.68c0-2.04-0.72-3.12-2.4-3.6m-3.24-7.72v4.64c0 0.68-0.32 1-1 1h-1.32v-6.64h1.32c0.68 0 1 0.32 1 1m-2.32 10.32h1.4c0.68 0 1 0.32 1 1v5.08c0 0.68-0.32 1-1 1h-1.4v-7.08"/>
<path d="m69.284 38.246c1.52-0.56 2.4-1.76 2.4-4.16v-5.4c0-3.48-1.72-5.2-5.2-5.2h-8.36v28h5.6v-10.6h1.4c0.68 0 1 0.32 1 1v9.6h5.6v-9.64c0-2.04-0.72-3.12-2.44-3.6m-3.2-8.88v5.76c0 0.68-0.32 1-1 1h-1.36v-7.76h1.36c0.68 0 1 0.32 1 1"/>
<path d="m87.513 46.526v-18.08c0-3.48-1.72-5.2-5.2-5.2h-3.6c-3.48 0-5.2 1.72-5.2 5.2v18.08c0 3.48 1.72 5.2 5.2 5.2h3.6c3.48 0 5.2-1.72 5.2-5.2m-5.6-17.48v16.88c0 0.68-0.32 1-1 1h-0.8c-0.68 0-1-0.32-1-1v-16.88c0-0.68 0.32-1 1-1h0.8c0.68 0 1 0.32 1 1"/>
<path d="m100.57 36.966-4.8-3.56c-0.68-0.48-0.96-0.92-0.96-1.8v-2.64c0-0.68 0.32-1 1-1h0.44c0.68 0 1 0.32 1 1v4.6h5.48v-5.12c0-3.48-1.72-5.2-5.2-5.2h-3.04c-3.48 0-5.2 1.72-5.2 5.2v4.44c0 2 0.52 3.16 2.24 4.4l4.8 3.56c0.68 0.48 0.96 0.92 0.96 1.8v3.36c0 0.68-0.32 1-1 1h-0.52c-0.68 0-1-0.32-1-1v-5.44h-5.48v5.96c0 3.48 1.72 5.2 5.2 5.2h3.12c3.48 0 5.2-1.72 5.2-5.2v-5.16c0-2.08-0.52001-3.16-2.24-4.4"/>
<path d="m106.98 51.486h6.16l1.44-12.72 1.44 12.72h6.16l3.4-28h-4.96l-1.44 14.88-1.6-14.88h-5.28l-1.6 14.92-1.44-14.92h-5.68l3.4 28"/>
<path d="m126.87 23.486v28h10.48v-5h-4.88v-6.72h4.6v-5h-4.6v-6.28h4.8v-5h-10.4"/>
<path d="m150.26 37.006c1.48-0.56 2.32-1.76 2.32-4.16v-4.16c0-3.48-1.72-5.2-5.2-5.2h-8.24v28h8.32c3.48 0 5.2-1.72 5.2-5.2v-5.68c0-2.04-0.72001-3.12-2.4-3.6m-3.24-7.72v4.64c0 0.68-0.32001 1-1 1h-1.32v-6.64h1.32c0.67999 0 1 0.32 1 1m-2.32 10.32h1.4c0.67999 0 1 0.32 1 1v5.08c0 0.68-0.32001 1-1 1h-1.4v-7.08"/>
</g>
</svg>
                      <span>LibrosWeb</span>
                  </a>
                </div>

                <div class="collapse navbar-collapse navbar-right" id="header-menu">
                  <ul class="nav navbar-nav pull-right">
                    
                                                <li class="">
                            <a href="/">
                                Inicio
                            </a>
                        </li>
                                                <li class="">
                            <a href="/libros/">
                                Libros
                            </a>
                        </li>
                                                <li class="">
                            <a href="/tutoriales/">
                                Tutoriales
                            </a>
                        </li>
                                                <li class="">
                            <a href="/eventos/">
                                Eventos
                            </a>
                        </li>
                                                <li class="active">
                            <a href="/foro/">
                                Foro
                            </a>
                        </li>
                                                <li class="">
                            <a href="/buscar">
                                Buscar
                            </a>
                        </li>
                                          </ul>
                </div>
              </div>
            </div>
        </div>

        <div id="wrapper" class="container">

            <div id="content" class="row">
                    <div class="module module-ad module-ad-responsive module-ad-top">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-1491000300253750"
         data-ad-slot="3770792827"
         data-ad-format="auto"></ins>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>


    <div itemscope="" itemtype="http://schema.org/Article">
        <div id="discussion" class="col-sm-9 ">
            <h1 class="title" itemprop="name">Consulta avanzada de fechas con Doctrine</h1>

            <div id="discussion-content" itemprop="description">
                <p>Hola, primero de todo deciros que soy nuevo con Symfony2. Estoy migrando a Symfony una aplicación hecha con CodeIgniter. El problema lo tengo con la consulta a la base de datos. Aquí pego el código y lo explico:</p>
<pre class="php code"><span class="kw2">public</span> <span class="kw2">function</span> horario<span class="br0">&#40;</span><span class="re0">$id_user</span><span class="sy0">,</span><span class="re0">$anio</span><span class="sy0">,</span><span class="re0">$mes</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="re0">$query</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">db</span><span class="sy0">-&gt;</span><span class="me1">query</span><span class="br0">&#40;</span><span class="st0">&quot;
      SELECT id_user,
             SUBTIME(hora_salida,hora_entrada) AS saldo,
             DATE_FORMAT(fecha,'<span class="es6">%d</span>/%m/%Y') AS fecha,
             DATE_FORMAT(fecha,'%W') AS dia, 
             DATE_FORMAT(fecha,'%Y-%m-<span class="es6">%d</span>') AS enlace,
             TIME_FORMAT(hora_entrada,'%H:%i') AS hora_entrada,
             TIME_FORMAT(hora_salida,'%H:%i') AS hora_salida
      FROM horario
      WHERE (id_user= '<span class="es4">$id_user</span>') &amp; (MONTH (fecha)='<span class="es4">$mes</span>') &amp; (YEAR (fecha)='<span class="es4">$anio</span>')
      ORDER BY fecha ASC
    &quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">return</span> <span class="re0">$query</span><span class="sy0">-&gt;</span><span class="me1">result</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="br0">&#125;</span></pre>
<pre class="php code"><span class="kw2">public</span> <span class="kw2">function</span> saldo_mensual<span class="br0">&#40;</span><span class="re0">$id_user</span><span class="sy0">,</span><span class="re0">$anio</span><span class="sy0">,</span><span class="re0">$mes</span><span class="br0">&#41;</span>
<span class="br0">&#123;</span>
    <span class="re0">$resultado</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">db</span><span class="sy0">-&gt;</span><span class="me1">query</span><span class="br0">&#40;</span>
      <span class="st0">&quot;SELECT SUBTIME(SEC_TO_TIME(sum(TIME_TO_SEC(hora_salida))), SEC_TO_TIME(sum(TIME_TO_SEC(hora_entrada)))) AS saldo,
              SEC_TO_TIME(sum(TIME_TO_SEC(hora_saldo))) AS super_saldo
       FROM horario
       WHERE (id_user='<span class="es4">$id_user</span>') &amp; (MONTH (fecha)='<span class="es4">$mes</span>') &amp; (YEAR (fecha)='<span class="es4">$anio</span>') &amp; (hora_salida != '00:00:00')&quot;</span>
    <span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
    <span class="kw1">return</span> <span class="re0">$resultado</span><span class="sy0">-&gt;</span><span class="me1">result</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>   
<span class="br0">&#125;</span></pre>
<p>El primero me calcula la diferencia entre dos horas, (entrada y salida) y me genera el saldo. Lo he conseguido en symfon con este código:</p>
<pre class="php code"><span class="re0">$conn</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">get</span><span class="br0">&#40;</span><span class="st_h">'database_connection'</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
<span class="re0">$entities</span> <span class="sy0">=</span> <span class="re0">$conn</span><span class="sy0">-&gt;</span><span class="me1">fetchAll</span><span class="br0">&#40;</span>
  <span class="st_h">'SELECT *,
          DATE_FORMAT(fecha,\'%W\') AS dia,
          SUBTIME(horaSalida,horaEntrada) AS saldo
   FROM Horario
   ORDER BY fecha ASC'</span>
<span class="br0">&#41;</span><span class="sy0">;</span></pre>
<p>Pero con Doctrine no hay manera y he revisado su documentación, foros de todo y nada. El problema concreto está en <code>SUBTIME</code>. No consigo hacer la resta de dos columnas y estoy convencido que debe tener forma, pero me lanza error. Gracias de antemano y disculpar por lo extenso del tema.</p>
            </div>

                            <div id="discussion-tags">
                    <h3>Etiquetas</h3>
                    <ul class="tags-list">
                                                                <li><a href="/foro/doctrine/">doctrine</a></li>
                                            <li><a href="/foro/symfony/">symfony</a></li>
                                        </ul>
                </div>
                    </div>

        <div id="discussion-attributes" class="col-sm-3">
            <div class="row">
                <p class="col-xs-3 col-sm-12 avatar">
                    <img width="73" height="73" itemprop="image"
                     src="http://pbs.twimg.com/profile_images/1588523075/imagesCAT8B9OB_bigger.jpg" />
                </p>

                <p class="col-xs-8 col-sm-12 col-md-12">
                    <span class="login">@casasxavi</span>
                    <meta itemprop="author" content="xavi" />

                    <span class="published">5 de abril de 2015</span>
                    <meta itemprop="dateCreated" content="2015-04-05T22:44:00+02:00" />
                </p>

                <p id="discussion-actions" class="col-sm-12">
                                    </p>
            </div>
        </div>
    </div>
    
    <div id="discussion-comments" class="col-sm-12">
                    <h2>Respuestas</h2>

                            <div class="row comment"  id="respuesta-1">
                                        

                    <div class="col-sm-1 col-md-1 permalink">
                        <a href="/foro/pregunta/547/consulta-avanzada-de-fechas-con-doctrine/#respuesta-1" title="Enlace permanente a esta respuesta">#1</a>
                    </div>

                    <div class="col-xs-12 col-sm-11 col-md-8 content" id="comment_1_html">
                        <p>@casasxavi antes que nada, y aunque seguramente ya lo sabes, Doctrine es un proyecto totalmente independiente a Symfony. Te lo comento porque como dices que eres nuevo en Symfony y vienes de CodeIgniter, quizás encuentres que Doctrine es la parte más difícil de este cambio.</p>
<p>Respecto a lo que quieres hacer: el problema de Doctrine es que es un ORM, lo que significa que ofrece las mismas funcionalidades en todas las bases de datos. En la práctica esto supone que no dispones de casi ninguna función propia de las bases de datos.</p>
<p>Una posible solución sería <a href="http://docs.doctrine-project.org/projects/doctrine-orm/en/latest/cookbook/dql-user-defined-functions.html">definir tus propias funciones DQL</a> para usarlas en las consultas de Doctrine y después <a href="http://symfony.com/doc/current/cookbook/doctrine/custom_dql_functions.html">registrar esas funciones en Symfony</a>. En cualquier caso, como estás empezando con Symfony, hacer esto sería una locura porque es muy avanzado.</p>
<p>Así que para este caso particular te aconsejo que te olvides de las propias consultas de Doctrine y ejecutes directamente el SQL de la siguiente manera (te pongo un ejemplo de cómo hacerlo dentro de un controlador):</p>
<pre class="php code"><span class="re0">$sql</span> <span class="sy0">=</span> <span class="st0">&quot;SELECT ...&quot;</span><span class="sy0">;</span>
<span class="re0">$stmt</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getDotrine</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">getManager</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">getConnection</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">-&gt;</span><span class="me1">prepare</span><span class="br0">&#40;</span><span class="re0">$sql</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$stmt</span><span class="sy0">-&gt;</span><span class="me1">execute</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
<span class="re0">$result</span> <span class="sy0">=</span> <span class="re0">$stmt</span><span class="sy0">-&gt;</span><span class="me1">fetchAll</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span></pre>
                    </div>

                    <div class="col-xs-12 col-sm-11 col-sm-offset-1 col-md-3 col-md-offset-0 comment-attributes">
                        <div class="row">
                            <p class="col-xs-2 col-sm-1 col-md-1 avatar">
                                <img width="48" height="48" src="http://pbs.twimg.com/profile_images/1616936371/avatar_normal.png" />
                            </p>

                            <p class="col-xs-9 col-sm-9 col-md-10">
                                <span class="login">
                                    @javiereguiluz
                                </span>

                                <span class="published">
                                    07-abr-15 09:26
                                </span>
                            </p>

                            <p class="col-sm-4 col-md-12 comment-actions">
                                                            </p>
                        </div>
                    </div>
                </div>
                            <div class="row comment"  id="respuesta-2">
                                        <i id="ultimo"></i>

                    <div class="col-sm-1 col-md-1 permalink">
                        <a href="/foro/pregunta/547/consulta-avanzada-de-fechas-con-doctrine/#respuesta-2" title="Enlace permanente a esta respuesta">#2</a>
                    </div>

                    <div class="col-xs-12 col-sm-11 col-md-8 content" id="comment_2_html">
                        <p>Hola, primero pedir disculpas por mi tardanza en contestar y segundo, darte las gracias. </p>
<p>Llevas razón al decir que Doctrine es una de las partes más difíciles del cambio, pero lo que voy conociendo me encanta; nada que ver con CodeIgniter.</p>
<p>Miraré bien las consultas direcamente al SQL y ya te comentaré. Una vez más, gracias.</p>
                    </div>

                    <div class="col-xs-12 col-sm-11 col-sm-offset-1 col-md-3 col-md-offset-0 comment-attributes">
                        <div class="row">
                            <p class="col-xs-2 col-sm-1 col-md-1 avatar">
                                <img width="48" height="48" src="http://pbs.twimg.com/profile_images/1588523075/imagesCAT8B9OB_normal.jpg" />
                            </p>

                            <p class="col-xs-9 col-sm-9 col-md-10">
                                <span class="login">
                                    @casasxavi
                                </span>

                                <span class="published">
                                    11-abr-15 16:55
                                </span>
                            </p>

                            <p class="col-sm-4 col-md-12 comment-actions">
                                                            </p>
                        </div>
                    </div>
                </div>
                    
                    <div id="btn-reply">
                <a rel="nofollow" href="/foro/pregunta/547/consulta-avanzada-de-fechas-con-doctrine/responder/#tu-respuesta" class="btn btn-lg">
                    Responder pregunta
                </a>
            </div>
            </div>


                </div>

            <div id="footer">
                <div class="row">
                    <div class="col-xs-12 col-sm-9">
                        &copy; 2015 LibrosWeb.es
                        <a href="/sitio/contacto">Contacto</a>
                        <a href="https://plus.google.com/+librosweb">Novedades</a>
                        <a href="/sitio/condiciones">Condiciones</a>
                        <a href="/sitio/privacidad">Privacidad</a>
                    </div>
                    <div class="col-xs-12 col-sm-3 uptime">
                        3.111 días online
                    </div>
                </div>
            </div>

        </div>

                                    <script src="/js/app.js"></script>
            
            <script type="text/javascript">
                console.log($(window).width());
            </script>
            </body>
</html>
