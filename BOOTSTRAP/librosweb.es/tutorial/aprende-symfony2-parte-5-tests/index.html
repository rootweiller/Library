<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:og="http://ogp.me/ns#"
      xmlns:fb="https://www.facebook.com/2008/fbml" xml:lang="es" lang="es">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta http-equiv="content-type" content="text/html; charset=utf-8">
        <title>Aprende Symfony2 (Parte 5): Tests</title>
                                    <link rel="stylesheet" href="/css/app.css" />
                        <script type="text/javascript">
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-82842-2', 'librosweb.es');
            ga('require', 'displayfeatures');
            ga('send', 'pageview');
        </script>
                        <link rel="apple-touch-icon" type="image/png" href="/apple-touch-icon.png">
        <link rel="apple-touch-icon-precomposed" type="image/png" href="/apple-touch-icon.png">
        <meta name="apple-mobile-web-app-title" content="LibrosWeb">
        <link rel="shortcut icon" type="image/png" href="/favicon.png">
        <meta name="site-version" content="a7f65a4">
                <link rel="publisher" href="http://plus.google.com/112008023125011571577">
                                                <meta name="twitter:site" content="@librosweb">
                <link rel="search" type="application/opensearchdescription+xml" href="http://librosweb.es/opensearch/documentation.xml" title="LibrosWeb">
                <meta property="fb:page_id" content="437758756273955">
                <meta property="fb:app_id" content="437758756273955">
        <meta property="og:type" content="website">
        <meta property="og:title" content="Aprende Symfony2 (Parte 5): Tests">
        <meta property="og:image" content="http://www.gravatar.com/avatar/9f219b4dfaa677bfd0f47753c02d5126.png?s=200">
                <meta name="msapplication-TileColor" content="#CC1414">
        <meta name="application-name" content="LibrosWeb">
        <meta name="msapplication-tooltip" content="Libros y tutoriales sobre HTML, CSS, JavaScript, PHP y otras tecnologías web.">
    </head>

    <body id="p-2-1" class="tutorials"><script type="text/javascript">
//<![CDATA[
try{(function(a){var b="http://",c="librosweb.es",d="/cdn-cgi/cl/",e="img.gif",f=new a;f.src=[b,c,d,e].join("")})(Image)}catch(e){}
//]]>
</script>
        <div class="content-background"></div>

        <div id="header">
            <div class="navbar navbar-default navbar-static-top">
              <div class="container">
                <div class="navbar-header">
                  <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#header-menu">
                    <span class="sr-only">Desplegar menú</span>
                    <i class="fa fa-menu"></i>
                  </button>
                  <a class="navbar-brand" href="/" title="LibrosWeb.es">
                      <svg xmlns="http://www.w3.org/2000/svg" version="1.1" viewBox="0 0 132 32" preserveAspectRatio="xMinYMin meet">
<g fill="#CC1414" transform="translate(-21.738 -21.148)">
<path d="m24.062 23.486v28h9.64v-5h-4.04v-23h-5.6"/>
<path d="m40.796 23.486h-5.6v28h5.6v-28"/>
<path d="m53.932 37.006c1.48-0.56 2.32-1.76 2.32-4.16v-4.16c0-3.48-1.72-5.2-5.2-5.2h-8.24v28h8.32c3.48 0 5.2-1.72 5.2-5.2v-5.68c0-2.04-0.72-3.12-2.4-3.6m-3.24-7.72v4.64c0 0.68-0.32 1-1 1h-1.32v-6.64h1.32c0.68 0 1 0.32 1 1m-2.32 10.32h1.4c0.68 0 1 0.32 1 1v5.08c0 0.68-0.32 1-1 1h-1.4v-7.08"/>
<path d="m69.284 38.246c1.52-0.56 2.4-1.76 2.4-4.16v-5.4c0-3.48-1.72-5.2-5.2-5.2h-8.36v28h5.6v-10.6h1.4c0.68 0 1 0.32 1 1v9.6h5.6v-9.64c0-2.04-0.72-3.12-2.44-3.6m-3.2-8.88v5.76c0 0.68-0.32 1-1 1h-1.36v-7.76h1.36c0.68 0 1 0.32 1 1"/>
<path d="m87.513 46.526v-18.08c0-3.48-1.72-5.2-5.2-5.2h-3.6c-3.48 0-5.2 1.72-5.2 5.2v18.08c0 3.48 1.72 5.2 5.2 5.2h3.6c3.48 0 5.2-1.72 5.2-5.2m-5.6-17.48v16.88c0 0.68-0.32 1-1 1h-0.8c-0.68 0-1-0.32-1-1v-16.88c0-0.68 0.32-1 1-1h0.8c0.68 0 1 0.32 1 1"/>
<path d="m100.57 36.966-4.8-3.56c-0.68-0.48-0.96-0.92-0.96-1.8v-2.64c0-0.68 0.32-1 1-1h0.44c0.68 0 1 0.32 1 1v4.6h5.48v-5.12c0-3.48-1.72-5.2-5.2-5.2h-3.04c-3.48 0-5.2 1.72-5.2 5.2v4.44c0 2 0.52 3.16 2.24 4.4l4.8 3.56c0.68 0.48 0.96 0.92 0.96 1.8v3.36c0 0.68-0.32 1-1 1h-0.52c-0.68 0-1-0.32-1-1v-5.44h-5.48v5.96c0 3.48 1.72 5.2 5.2 5.2h3.12c3.48 0 5.2-1.72 5.2-5.2v-5.16c0-2.08-0.52001-3.16-2.24-4.4"/>
<path d="m106.98 51.486h6.16l1.44-12.72 1.44 12.72h6.16l3.4-28h-4.96l-1.44 14.88-1.6-14.88h-5.28l-1.6 14.92-1.44-14.92h-5.68l3.4 28"/>
<path d="m126.87 23.486v28h10.48v-5h-4.88v-6.72h4.6v-5h-4.6v-6.28h4.8v-5h-10.4"/>
<path d="m150.26 37.006c1.48-0.56 2.32-1.76 2.32-4.16v-4.16c0-3.48-1.72-5.2-5.2-5.2h-8.24v28h8.32c3.48 0 5.2-1.72 5.2-5.2v-5.68c0-2.04-0.72001-3.12-2.4-3.6m-3.24-7.72v4.64c0 0.68-0.32001 1-1 1h-1.32v-6.64h1.32c0.67999 0 1 0.32 1 1m-2.32 10.32h1.4c0.67999 0 1 0.32 1 1v5.08c0 0.68-0.32001 1-1 1h-1.4v-7.08"/>
</g>
</svg>
                      <span>LibrosWeb</span>
                  </a>
                </div>

                <div class="collapse navbar-collapse navbar-right" id="header-menu">
                  <ul class="nav navbar-nav pull-right">
                    
                                                <li class="">
                            <a href="/">
                                Inicio
                            </a>
                        </li>
                                                <li class="">
                            <a href="/libros/">
                                Libros
                            </a>
                        </li>
                                                <li class="active">
                            <a href="/tutoriales/">
                                Tutoriales
                            </a>
                        </li>
                                                <li class="">
                            <a href="/eventos/">
                                Eventos
                            </a>
                        </li>
                                                <li class="">
                            <a href="/foro/">
                                Foro
                            </a>
                        </li>
                                                <li class="">
                            <a href="/buscar">
                                Buscar
                            </a>
                        </li>
                                          </ul>
                </div>
              </div>
            </div>
        </div>

        <div id="wrapper" class="container">

            <div id="content" class="row">
                                    <div id="main" class="col-sm-9">
                            <h1 class="title">Aprende Symfony2 (Parte 5): Tests</h1>

    <p>Este es el quinto artículo de la serie para aprender sobre <a href="http://symfony.com/">el framework Symfony2</a>. En los anteriores artículos desarrollamos una aplicación sencilla que muestra información sobre empresas y que contiene los siguientes archivos:</p>
<pre class="code code">.
├── app
│   ├── AppKernel.php
│   ├── cache
│   │   └── .gitkeep
│   ├── config
│   │   ├── config.yml
│   │   └── routing.yml
│   └── logs
│       └── .gitkeep
├── composer.json
├── composer.lock
├── src
│    └── AppBundle
│        ├── Controller
│        │   └── ApiController.php
│        └── AppBundle.php
├── .gitignore
└── web
    └── app.php</pre>
<p>Ejecutar el comando <code>composer install</code> debería crear el directorio <code>vendor/</code>, que hemos ignorado en Git. Si lo necesitas, echa un vistazo al <a href="https://github.com/gnugat/learning-symfony2/">repositorio de código público en el que estamos desarrollando la aplicación</a>. En este artículo crearemos tests funcionales utilizando PHPUnit.</p>
<h2>Instalando PHPUnit</h2>
<p><a href="http://phpunit.de/">PHPUnit</a> es un <em>framework</em> muy popular para crear tests.
Su nombre engaña un poco, ya que no solo sirve para crear test unitarios, sino que puedes crear también tests funcionales, test tipo <em>end to end</em>, etc.</p>
<p>En primer lugar, instalemos PHPUnit en nuestro proyecto:</p>
<pre class="cli code">$ composer require --dev phpunit/phpunit</pre>
<p>La opción <code>--dev</code> evitará que Composer instale PHPUnit cuando ejecutemos
<code>composer install --no-dev</code>. Esto es especialmente útil en el entorno de producción, donde seguramente no querremos instalar PHPUnit.</p>
<p>Después necesitamos crear un archivo de configuración que le diga a PHPUnit que
ejecute los tests que se encuentran en <code>src/AppBundle/Tests</code>, y que use
Composer como <em>autoloader</em>:</p>
<pre class="xml code"><span class="sc3"><span class="re1">&lt;?xml</span> <span class="re0">version</span>=<span class="st0">&quot;1.0&quot;</span> <span class="re0">encoding</span>=<span class="st0">&quot;UTF-8&quot;</span><span class="re2">?&gt;</span></span>
    <span class="sc-1">&lt;!-- File: app/phpunit.xml.dist --&gt;</span>
&nbsp;
    <span class="sc-1">&lt;!-- http://phpunit.de/manual/current/en/appendixes.configuration.html --&gt;</span>
    <span class="sc3"><span class="re1">&lt;phpunit</span></span>
<span class="sc3">        <span class="re0">backupGlobals</span>=<span class="st0">&quot;false&quot;</span></span>
<span class="sc3">        <span class="re0">colors</span>=<span class="st0">&quot;true&quot;</span></span>
<span class="sc3">        <span class="re0">syntaxCheck</span>=<span class="st0">&quot;false&quot;</span></span>
<span class="sc3">        <span class="re0">bootstrap</span>=<span class="st0">&quot;../vendor/autoload.php&quot;</span><span class="re2">&gt;</span></span>
&nbsp;
        <span class="sc3"><span class="re1">&lt;testsuites<span class="re2">&gt;</span></span></span>
            <span class="sc3"><span class="re1">&lt;testsuite</span> <span class="re0">name</span>=<span class="st0">&quot;Functional Test Suite&quot;</span><span class="re2">&gt;</span></span>
                <span class="sc3"><span class="re1">&lt;directory<span class="re2">&gt;</span></span></span>../src/AppBundle/Tests<span class="sc3"><span class="re1">&lt;/directory<span class="re2">&gt;</span></span></span>
            <span class="sc3"><span class="re1">&lt;/testsuite<span class="re2">&gt;</span></span></span>
        <span class="sc3"><span class="re1">&lt;/testsuites<span class="re2">&gt;</span></span></span>
&nbsp;
    <span class="sc3"><span class="re1">&lt;/phpunit<span class="re2">&gt;</span></span></span></pre>
<blockquote>
<p><strong>NOTA</strong> Una de las convenciones de Symfony dice que los tests deberían seguir la misma estructura de archivos y directorios que la aplicación. Por eso los tests deberían crearse en <code>src/AppBundle/Tests</code>. No es obligatorio, pero si quieres que otra gente encuentre las cosas donde esperan encontrarlas, es mejor que lo hagas así.</p>
</blockquote>
<p>Este archivo lleva el sufijo <code>.dist</code> porque la idea es que cada desarrollador
pueda sobreescribir la configuración creando un archivo <code>app/phpunit.xml</code>. Sólo
el archivo común de tipo <code>.dist</code> debe ser publicado:</p>
<pre class="cli code">$ echo '/app/phpunit.xml' &gt;&gt; .gitignore
$ git add -A
$ git commit -m 'PHPUnit instalado'</pre>
<h2>Entornos de ejecución</h2>
<p>Para nuestros tests funcionales, utilizaremos la clase <code>WebTestCase</code>, que instancia nuestro <code>AppKernel</code> con el entorno <code>test</code>. También usa el servicio
<code>test.client</code>, que está desactivado por defecto.</p>
<p>Para activarlo, debemos modificar la configuración:</p>
<pre class="yaml code"><span class="co1"># app/config/config.yml</span><span class="co4">
framework</span>:<span class="co3">
    secret</span><span class="sy2">: </span><span class="st0">&quot;El valor de esta opción debe ser una cadena aleatoria.&quot;</span><span class="co4">
    router</span>:<span class="co3">
        resource</span><span class="sy2">: </span><span class="co2">%kernel.root_dir%/config/routing.yml</span>
&nbsp;
    <span class="co1"># test: ~</span></pre>
<p>Normalmente no queremos que nuestra configuración sea la misma en nuestros tests y en nuestro servidor de producción. Para eso están los entornos. Coloquemos la configuración específica de nuestros tests en un archivo diferente:</p>
<pre class="yaml code"><span class="co1"># app/config/config_test.yml</span><span class="co4">
imports</span>:<span class="co3">
    - { resource</span><span class="sy2">: </span>config.yml <span class="br0">&#125;</span>
<span class="co4">
framework</span>:<span class="co3">
    test</span><span class="sy2">: </span>~</pre>
<blockquote>
<p><strong>NOTA</strong> El parámetro <code>imports</code> te permite incluir otros archivos de configuración. Así, puedes sobreescribir los parámetros incluídos, o añadir nuevos.</p>
</blockquote>
<p>Deberíamos cambiar también el método <code>registerContainerConfiguration</code> de la
clase <code>AppKernel</code> para que cargue la configuración de los tests dependiendo del
entorno:</p>
<pre class="php code"><span class="kw2">&lt;?php</span>
<span class="co1">// app/AppKernel.php</span>
&nbsp;
<span class="kw2">use</span> Symfony\Component\HttpKernel\Kernel<span class="sy0">;</span>
<span class="kw2">use</span> Symfony\Component\Config\Loader\LoaderInterface<span class="sy0">;</span>
&nbsp;
<span class="kw2">class</span> AppKernel <span class="kw2">extends</span> Kernel
<span class="br0">&#123;</span>
    <span class="kw2">public</span> <span class="kw2">function</span> registerBundles<span class="br0">&#40;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="kw1">return</span> <span class="kw3">array</span><span class="br0">&#40;</span>
            <span class="kw2">new</span> Symfony\Bundle\FrameworkBundle\FrameworkBundle<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span>
            <span class="kw2">new</span> AppBundle\AppBundle<span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span>
        <span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw2">public</span> <span class="kw2">function</span> registerContainerConfiguration<span class="br0">&#40;</span>LoaderInterface <span class="re0">$loader</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$file</span> <span class="sy0">=</span> <span class="st_h">'config'</span><span class="sy0">;</span>
        <span class="kw1">if</span> <span class="br0">&#40;</span><span class="st_h">'test'</span> <span class="sy0">===</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">getEnvironment</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span> <span class="br0">&#123;</span>
            <span class="re0">$file</span> <span class="sy0">.=</span> <span class="st_h">'_test'</span><span class="sy0">;</span>
        <span class="br0">&#125;</span>
        <span class="re0">$loader</span><span class="sy0">-&gt;</span><span class="me1">load</span><span class="br0">&#40;</span>__DIR__<span class="sy0">.</span><span class="st0">&quot;/config/<span class="es4">$file</span>.yml&quot;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
<p>Hagamos un commit al repositorio:</p>
<pre class="cli code">$ git add -A
$ git commit -m 'Añadida  la configuración de testing'</pre>
<h2>Tests funcionales</h2>
<p>Nuestro test debe comprobar que la aplicación se comporta como esperamos. No
comprobaremos que realmente ejecuta bien toda la lógica de negocio, por lo que comprobar el código de estado HTTP es más que suficiente.</p>
<p>Creemos el directorio:</p>
<pre class="cli code">$ mkdir -p src/AppBundle/Tests/Controller</pre>
<blockquote>
<p><strong>NOTA</strong> En este caso, también por convención, se recomienda que la estructura de directorios de los tests sea la misma que la del <em>bundle</em>.</p>
</blockquote>
<p>Y este es nuestro primer test funcional:</p>
<pre class="php code"><span class="kw2">&lt;?php</span>
<span class="co1">// src/AppBundle/Tests/Controller/ApiControllerTest.php</span>
<span class="kw2">namespace</span> AppBundle<span class="sy0">/</span>Tests<span class="sy0">/</span>Controller<span class="sy0">;</span>
&nbsp;
<span class="kw2">use</span> Symfony\Bundle\FrameworkBundle\Test\WebTestCase<span class="sy0">;</span>
&nbsp;
<span class="kw2">class</span> ApiControllerTest <span class="kw2">extends</span> WebTestCase
<span class="br0">&#123;</span>
    <span class="kw2">public</span> <span class="kw2">function</span> testInformacionSobreEmpresaExistente<span class="br0">&#40;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$method</span> <span class="sy0">=</span> <span class="st_h">'POST'</span><span class="sy0">;</span>
        <span class="re0">$uri</span> <span class="sy0">=</span> <span class="st_h">'/api/informacion'</span><span class="sy0">;</span>
        <span class="re0">$parameters</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$files</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$server</span> <span class="sy0">=</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$content</span> <span class="sy0">=</span> <span class="kw3">json_encode</span><span class="br0">&#40;</span><span class="kw3">array</span><span class="br0">&#40;</span>
            <span class="st_h">'empresa'</span> <span class="sy0">=&gt;</span> <span class="st_h">'ACME'</span><span class="sy0">,</span>
        <span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="re0">$client</span> <span class="sy0">=</span> static<span class="sy0">::</span><span class="me2">createClient</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$client</span><span class="sy0">-&gt;</span><span class="me1">request</span><span class="br0">&#40;</span><span class="re0">$method</span><span class="sy0">,</span> <span class="re0">$uri</span><span class="sy0">,</span> <span class="re0">$parameters</span><span class="sy0">,</span> <span class="re0">$files</span><span class="sy0">,</span> <span class="re0">$server</span><span class="sy0">,</span> <span class="re0">$content</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$response</span> <span class="sy0">=</span> <span class="re0">$client</span><span class="sy0">-&gt;</span><span class="me1">getResponse</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">assertTrue</span><span class="br0">&#40;</span><span class="re0">$response</span><span class="sy0">-&gt;</span><span class="me1">isSuccessful</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
<p>Para comprobar que pasamos el test, ejecuta el siguiente comando:</p>
<pre class="cli code">$ ./vendor/bin/phpunit -c app</pre>
<p>Al instalar PHPUnit, Composer creó un archivo binario llamado <code>phpunit</code> en el directorio <code>vendor/bin</code>. La opción <code>-c</code> le dice a PHPUnit dónde está su archivo de configuración (en el caso de las aplicaciones Symfony, este archivo siempre se encuentra en <code>app/</code>).</p>
<p>El código de nuestro test es un poco largo por culpa de los parámetros. Para simplificarlo podemos utilizar los métodos auxiliares:</p>
<pre class="php code"><span class="kw2">&lt;?php</span>
<span class="co1">// src/AppBundle/Tests/Controller/ApiControllerTest.php</span>
&nbsp;
<span class="kw2">namespace</span> AppBundle<span class="sy0">/</span>Tests<span class="sy0">/</span>Controller<span class="sy0">;</span>
&nbsp;
<span class="kw2">use</span> Symfony\Bundle\FrameworkBundle\Test\WebTestCase<span class="sy0">;</span>
&nbsp;
<span class="kw2">class</span> ApiControllerTest <span class="kw2">extends</span> WebTestCase
<span class="br0">&#123;</span>
    <span class="kw2">private</span> <span class="kw2">function</span> post<span class="br0">&#40;</span><span class="re0">$uri</span><span class="sy0">,</span> <span class="kw3">array</span> <span class="re0">$data</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$content</span> <span class="sy0">=</span> <span class="kw3">json_encode</span><span class="br0">&#40;</span><span class="re0">$data</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$client</span> <span class="sy0">=</span> static<span class="sy0">::</span><span class="me2">createClient</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$client</span><span class="sy0">-&gt;</span><span class="me1">request</span><span class="br0">&#40;</span><span class="st_h">'POST'</span><span class="sy0">,</span> <span class="re0">$uri</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="re0">$content</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">return</span> <span class="re0">$client</span><span class="sy0">-&gt;</span><span class="me1">getResponse</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw2">public</span> <span class="kw2">function</span> testInformacionSobreEmpresaExistente<span class="br0">&#40;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$response</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">post</span><span class="br0">&#40;</span><span class="st_h">'/api/informacion'</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'empresa'</span> <span class="sy0">=&gt;</span> <span class="st_h">'ACME'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">assertTrue</span><span class="br0">&#40;</span><span class="re0">$response</span><span class="sy0">-&gt;</span><span class="me1">isSuccessful</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
<p>Ahora comprueba que el test sigue pasando correctamente:</p>
<pre class="cli code">$ ./vendor/bin/phpunit -c app</pre>
<p>El método <code>isSuccessful</code> de Response sólo comprueba que el código de estado es
2xx. Aquí está el test para el caso de error:</p>
<pre class="php code"><span class="kw2">&lt;?php</span>
<span class="co1">// src/AppBundle/Tests/Controller/ApiControllerTest.php</span>
&nbsp;
<span class="kw2">namespace</span> AppBundle<span class="sy0">/</span>Tests<span class="sy0">/</span>Controller<span class="sy0">;</span>
&nbsp;
<span class="kw2">use</span> Symfony\Bundle\FrameworkBundle\Test\WebTestCase<span class="sy0">;</span>
&nbsp;
<span class="kw2">class</span> ApiControllerTest <span class="kw2">extends</span> WebTestCase
<span class="br0">&#123;</span>
    <span class="kw2">private</span> <span class="kw2">function</span> post<span class="br0">&#40;</span><span class="re0">$uri</span><span class="sy0">,</span> <span class="kw3">array</span> <span class="re0">$data</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$content</span> <span class="sy0">=</span> <span class="kw3">json_encode</span><span class="br0">&#40;</span><span class="re0">$data</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$client</span> <span class="sy0">=</span> static<span class="sy0">::</span><span class="me2">createClient</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$client</span><span class="sy0">-&gt;</span><span class="me1">request</span><span class="br0">&#40;</span><span class="st_h">'POST'</span><span class="sy0">,</span> <span class="re0">$uri</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="re0">$content</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">return</span> <span class="re0">$client</span><span class="sy0">-&gt;</span><span class="me1">getResponse</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw2">public</span> <span class="kw2">function</span> testInformacionSobreEmpresaExistente<span class="br0">&#40;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$response</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">post</span><span class="br0">&#40;</span><span class="st_h">'/api/informacion'</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'empresa'</span> <span class="sy0">=&gt;</span> <span class="st_h">'ACME'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">assertTrue</span><span class="br0">&#40;</span><span class="re0">$response</span><span class="sy0">-&gt;</span><span class="me1">isSuccessful</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw2">public</span> <span class="kw2">function</span> testInformacionSobreEmpresaInexistente<span class="br0">&#40;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$response</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">post</span><span class="br0">&#40;</span><span class="st_h">'/api/informacion'</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'empresa'</span> <span class="sy0">=&gt;</span> <span class="st_h">'NO_EXISTE'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">assertFalse</span><span class="br0">&#40;</span><span class="re0">$response</span><span class="sy0">-&gt;</span><span class="me1">isSuccessful</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
<p>Ahora ejecuta de nuevo los tests:</p>
<pre class="cli code">$ ./vendor/bin/phpunit -c app</pre>
<blockquote>
<p><strong>NOTA</strong> A partir de ahora, deberías acostumrbarte a ejecutar los tests continuamente. Asegúrate de ejecutarlos siempre que termines un cambio, y de ejecutarlos de nuevo antes de añadir nada al repositorio.</p>
</blockquote>
<h2>Tests funcionales de la API Rest</h2>
<p>En mi opinión, comprobar que el código de estado es 2xx y no comprobar
el contenido de la respuesta es más que suficiente para un test funcional.</p>
<p>Al crear una API REST, puede ser útil testear con más precisión el código de
estado. Nuestra aplicación es una API REST, así que hagámoslo:</p>
<pre class="php code"><span class="kw2">&lt;?php</span>
<span class="co1">// src/AppBundle/Tests/Controller/ApiControllerTest.php</span>
&nbsp;
<span class="kw2">namespace</span> AppBundle<span class="sy0">/</span>Tests<span class="sy0">/</span>Controller<span class="sy0">;</span>
&nbsp;
<span class="kw2">use</span> Symfony\Bundle\FrameworkBundle\Test\WebTestCase<span class="sy0">;</span>
<span class="kw2">use</span> Symfony\Component\HttpFoundation\Response<span class="sy0">;</span>
&nbsp;
<span class="kw2">class</span> ApiControllerTest <span class="kw2">extends</span> WebTestCase
<span class="br0">&#123;</span>
    <span class="kw2">private</span> <span class="kw2">function</span> post<span class="br0">&#40;</span><span class="re0">$uri</span><span class="sy0">,</span> <span class="kw3">array</span> <span class="re0">$data</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$content</span> <span class="sy0">=</span> <span class="kw3">json_encode</span><span class="br0">&#40;</span><span class="re0">$data</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$client</span> <span class="sy0">=</span> static<span class="sy0">::</span><span class="me2">createClient</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
        <span class="re0">$client</span><span class="sy0">-&gt;</span><span class="me1">request</span><span class="br0">&#40;</span><span class="st_h">'POST'</span><span class="sy0">,</span> <span class="re0">$uri</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">,</span> <span class="re0">$content</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="kw1">return</span> <span class="re0">$client</span><span class="sy0">-&gt;</span><span class="me1">getResponse</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw2">public</span> <span class="kw2">function</span> testInformacionSobreEmpresaExistente<span class="br0">&#40;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$response</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">post</span><span class="br0">&#40;</span><span class="st_h">'/api/informacion'</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'empresa'</span> <span class="sy0">=&gt;</span> <span class="st_h">'ACME'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">assertSame</span><span class="br0">&#40;</span>Response<span class="sy0">::</span><span class="me2">HTTP_OK</span> <span class="sy0">,</span> <span class="re0">$response</span><span class="sy0">-&gt;</span><span class="me1">getStatusCode</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
&nbsp;
    <span class="kw2">public</span> <span class="kw2">function</span> testInformacionSobreEmpresaInexistente<span class="br0">&#40;</span><span class="br0">&#41;</span>
    <span class="br0">&#123;</span>
        <span class="re0">$response</span> <span class="sy0">=</span> <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">post</span><span class="br0">&#40;</span><span class="st_h">'/api/informacion'</span><span class="sy0">,</span> <span class="kw3">array</span><span class="br0">&#40;</span><span class="st_h">'empresa'</span> <span class="sy0">=&gt;</span> <span class="st_h">'NO_EXISTE'</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
&nbsp;
        <span class="re0">$this</span><span class="sy0">-&gt;</span><span class="me1">assertSame</span><span class="br0">&#40;</span>Response<span class="sy0">::</span><span class="me2">HTTP_UNPROCESSABLE_ENTITY</span> <span class="sy0">,</span> <span class="re0">$response</span><span class="sy0">-&gt;</span><span class="me1">getStatusCode</span><span class="br0">&#40;</span><span class="br0">&#41;</span><span class="br0">&#41;</span><span class="sy0">;</span>
    <span class="br0">&#125;</span>
<span class="br0">&#125;</span></pre>
<p>Y ahora ejecuta de nuevo los tests:</p>
<pre class="cli code">$ ./vendor/bin/phpunit -c app</pre>
<p>¡Verde! ¡Es suficiente recompensa como para hacer un commit al repositorio
y dar la jornada por terminada!</p>
<pre class="cli code">$ git add -A
$ git commit -m 'Tests añadidos'</pre>
<h2>Conclusión</h2>
<p>¡Ejecutar <code>./vendor/bin/phpunit -c app</code> es más sencillo que tener que ejecutar
manualmente <code>HTTPie</code> (como en el artículo anterior)!</p>
<p>Escribir tests funcionales es fácil y rápido, lo único que debes hacer es
comprobar si el código de estado HTTP es correcto (y para una API REST, comprobar con precisión el código de estado HTTP).</p>
<p>El próximo artículo será un resumen de esta serie, ¡espero que te haya gustado!</p>
<h2>Sobre el autor</h2>
<p>Este artículo fue publicado originalmente por <a href="https://github.com/gnugat">Loïc Chardonnet</a> y ha sido traducido con permiso por <a href="https://github.com/mgdepoo">Manuel Gómez</a>.</p>
<h2>Artículos de la serie Aprende Symfony</h2>
<ul>
<li><a href="http://librosweb.es/tutorial/aprende-symfony2-parte-1-composer/">Aprende Symfony2 (Parte 1): Composer</a></li>
<li><a href="http://librosweb.es/tutorial/aprende-symfony2-parte-2-aplicacion-vacia/">Aprende Symfony2 (Parte 2): Aplicación vacía</a></li>
<li><a href="http://librosweb.es/tutorial/aprende-symfony2-parte-3-bundles/">Aprende Symfony2 (Parte 3): Bundles</a></li>
<li><a href="http://librosweb.es/tutorial/aprende-symfony2-parte-4-controladores/">Aprende Symfony2 (Parte 4): Controladores</a></li>
<li><a href="http://librosweb.es/tutorial/aprende-symfony2-parte-5-tests/">Aprende Symfony2 (Parte 5): Tests</a></li>
<li><a href="http://librosweb.es/tutorial/aprende-symfony2-parte-6-conclusion/">Aprende Symfony2 (Parte 6): Conclusión</a></li>
</ul>

                    </div>

                    <div id="sidebar" class="col-sm-3">
                            <div class="module module-ad module-ad-responsive module-ad-sidebar">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-1491000300253750"
         data-ad-slot="3770792827"
         data-ad-format="auto"></ins>
    <script>
    (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
</div>


    <div class="module module-share">
    <h3>Compartir</h3>
    <ul>
    <li><a id="share_twitter" href="#" title="Compartir en Twitter">Twitter</a></li>
    <li><a id="share_facebook" href="#" title="Compartir en Facebook">Facebook</a></li>
    <li><a id="share_google" href="#" title="Compartir en Google+">Google+</a></li>
</ul>

<script type="text/javascript">
var title    = 'Aprende Symfony2 (Parte 5): Tests';
var page_url = encodeURIComponent(window.location);
var options  = 'menubar=no,toolbar=no,resizable=yes,scrollbars=no,width=640,height=350';
var services = {
    share_twitter:  'https://twitter.com/share?text=' + title + '&lang=es',
    share_facebook: 'http://www.facebook.com/sharer.php?u=' + page_url + '&t=' + title,
    share_google:   'https://plus.google.com/share?url=' + page_url + '&hl=es'
};

for (var id in services) {
    if (services.hasOwnProperty(id)) {
        document.getElementById(id).href = services[id];
        document.getElementById(id).onclick = function(a) {
            a = a || window.event;
            a = a.target || a.srcElement;

            ga('send', 'social', {
                'socialNetwork' : a.id.substr(6),
                'socialAction'  : 'share',
                'socialTarget'  : window.location
            });

            window.open(services[a.id], a.title, options);

            return false;
        };
    }
}
</script>

</div>


    
<div class="module module-tags">
    <h3>Etiquetas populares</h3>
    <ul class="tags-list">
                    <li class="">
                <a href="/tutoriales/composer/">composer</a>
            </li>
                    <li class="">
                <a href="/tutoriales/css/">css</a>
            </li>
                    <li class="">
                <a href="/tutoriales/dise%C3%B1o/">diseño</a>
            </li>
                    <li class="">
                <a href="/tutoriales/html/">html</a>
            </li>
                    <li class="">
                <a href="/tutoriales/javascript/">javascript</a>
            </li>
                    <li class="">
                <a href="/tutoriales/php/">php</a>
            </li>
                    <li class="">
                <a href="/tutoriales/programaci%C3%B3n/">programación</a>
            </li>
                    <li class="">
                <a href="/tutoriales/sistemas/">sistemas</a>
            </li>
                    <li class="">
                <a href="/tutoriales/symfony/">symfony</a>
            </li>
            </ul>
</div>


    <div class="module module-rss">
    <h3>Suscríbete gratis</h3>
    <ul class="list-unstyled text-links module-rss-feeds">
        <li>
            <i class="icon">RSS</i>
            <a href="/rss/tutoriales/todos.xml">
                <strong>Todos</strong> los tutoriales
            </a>
        </li>
        <li>
            <i class="icon">RSS</i>
            <a href="/rss/tutoriales/diseno.xml">
                Tutoriales de <strong>diseño</strong>
            </a>
        </li>
        <li>
            <i class="icon">RSS</i>
            <a href="/rss/tutoriales/programacion.xml">
                Tutoriales de <strong>programación</strong>
            </a>
        </li>
    </ul>
</div>

                    </div>
                            </div>

            <div id="footer">
                <div class="row">
                    <div class="col-xs-12 col-sm-9">
                        &copy; 2015 LibrosWeb.es
                        <a href="/sitio/contacto">Contacto</a>
                        <a href="https://plus.google.com/+librosweb">Novedades</a>
                        <a href="/sitio/condiciones">Condiciones</a>
                        <a href="/sitio/privacidad">Privacidad</a>
                    </div>
                    <div class="col-xs-12 col-sm-3 uptime">
                        3.111 días online
                    </div>
                </div>
            </div>

        </div>

                                    <script src="/js/app.js"></script>
            
            <script type="text/javascript">
                console.log($(window).width());
            </script>
            </body>
</html>
